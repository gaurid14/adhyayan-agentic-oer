{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contributor Dashboard | Adhyayan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'accounts/sidebar.css' %}">

    <style>
        :root {
          --bg-page: #ffffff;
          --bg-card: #f7f8fa;
          --border-soft: #e6e8ec;

          --text-primary: #0f172a; /* slate-900 */
          --text-secondary: #475569; /* slate-600 */

          --brand: #0f766e; /* muted enterprise teal */
          --brand-soft: #e6f4f1;
          --brand-hover: #115e59;
        }

        /* =====================
             RESET & BASE
          ===================== */
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-family: "Segoe UI", sans-serif;
        }
        body {
          background: #ffffff;
          color: #333;
          display: flex;
          min-height: 100vh;
        }
        ul {
          list-style: none;
        }

        /* =====================
             LAYOUT
          ===================== */
        .dashboard-layout {
          display: flex;
          width: 100%;
        }

        /* =====================
             MAIN CONTENT
          ===================== */
        .main-content {
          flex-grow: 1;
          margin-left: 260px;
          padding: 30px 40px;
        }

        /* TOP BAR */
        .topbar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #fff;
          padding: 12px 20px;
          border-radius: 10px;
          border: 1px solid #e5e7eb;
          box-shadow: none;
          margin-bottom: 25px;
        }

        .topbar-left {
          display: flex;
          align-items: center;
          gap: 15px;
        }
        .role-badge {
          background: #e6f8f7;
          color: #1eae98;
          font-size: 12px;
          padding: 4px 10px;
          border-radius: 20px;
          font-weight: 600;
        }

        .topbar-right {
          display: flex;
          align-items: center;
          gap: 20px;
        }
        .notification-icon {
          font-size: 18px;
          cursor: pointer;
        }
        .user-chip {
          background: #f9fafb;
          border: 1px solid #e5e7eb;
          color: #111827;
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 14px;
        }

        /* PAGE HEADER */
        .main-header h1 {
          font-size: 24px;
          margin-bottom: 20px;
        }

        /* =====================
             KPI CARDS
          ===================== */
        .kpi-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        }

        .kpi-card {
          background: #fff;
          padding: 20px;
          border-radius: 12px;
          border: 1px solid #e5e7eb;
          box-shadow: 0 1px 1px rgba(0, 0, 0, 0.02);
        }

        .kpi-card h3 {
          color: var(--text-primary);
          font-weight: 600;
        }

        .org-name {
          color: var(--text-primary);
        }

        /* =====================
             CONTENT SECTIONS
          ===================== */
        .content-section {
          display: none;
        }
        .content-section.active {
          display: block;
          animation: fadeIn 0.4s ease;
        }

        /* =====================
             CARDS
          ===================== */
        .card {
          background: #fff;
          border-radius: 12px;
          padding: 25px;
          border: 1px solid #e5e7eb;
          box-shadow: 0 1px 1px rgba(0, 0, 0, 0.02);
          margin-bottom: 30px;
        }
        .card-title {
          font-size: 20px;
          color: #111827;
          font-weight: 600;
          margin-bottom: 20px;
          border-bottom: 1px solid #eee;
          padding-bottom: 10px;
        }
        .card {
          border: 1px solid #e6e8ec;
        }

        body {
          color: #1f2937;
        }

        p,
        td {
          color: #374151;
        }

        /* =====================
             COURSE GRID
          ===================== */
        .course-grid {
          display: grid;
          grid-template-columns: repeat(2, minmax(340px, 1fr));
          gap: 20px;
          align-items: stretch;
        }

        @media (max-width: 1100px) {
          .course-grid {
            grid-template-columns: 1fr;
          }
        }


        .course-card {
          background: #ffffff;
          padding: 18px 20px;
          border-radius: 12px;
          border: 1px solid #e5e7eb;

          /* ‚úÖ Equal height system */
          height: 100%;
          display: flex;
          flex-direction: column;
          justify-content: space-between;

          /* ‚úÖ smoother hover */
          transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
        }

        .course-card:hover {
          transform: translateY(-3px);
          border-color: rgba(30, 174, 152, 0.5);
          box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
          background: #ffffff;
        }

        .course-card h4 {
          margin-bottom: 6px;
        }
        .course-card p {
          font-size: 13px;
          color: #777;
          margin-bottom: 15px;
        }

        .status {
          position: absolute;
          top: 15px;
          right: 15px;
          font-size: 12px;
          padding: 4px 10px;
          border-radius: 12px;
          font-weight: 600;
        }
        .status.approved {
          background: var(--brand-soft);
          color: var(--brand);
        }

        .card,
        .topbar,
        .course-card {
          border: 1px solid #e5e7eb;
          box-shadow:
            0 1px 1px rgba(0, 0, 0, 0.02),
            0 1px 2px rgba(0, 0, 0, 0.02);
        }

        .primary-btn {
          background: #1eae98;
          color: #fff;
          border: none;
          padding: 8px 14px;
          border-radius: 6px;
          cursor: pointer;
        }
        .primary-btn:hover {
          background: #178d79;
        }

        /* =====================
             CONTRIBUTIONS
          ===================== */
        .content-list li {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 10px;
          border-left: 4px solid #1eae98;
        }

        .badge {
          padding: 4px 10px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
        }
        .badge.pending {
          background: #fff3cd;
          color: #856404;
        }
        .badge.evaluated {
          background: #d4edda;
          color: #155724;
        }

        /* =====================
             MODAL
          ===================== */
        .modal-overlay {
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.6);
          display: flex;
          align-items: center;
          justify-content: center;
          opacity: 0;
          visibility: hidden;
          transition: 0.3s;
          z-index: 1000;
        }
        body.modal-open .modal-overlay {
          opacity: 1;
          visibility: visible;
        }

        .modal {
          background: #fff;
          width: 90%;
          max-width: 500px;
          border-radius: 12px;
          padding: 20px;
        }

        /* =====================
             ANIMATIONS
          ===================== */
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: none;
          }
        }

        .notification-wrapper {
          position: relative;
        }

        .notification-btn {
          background: none;
          border: none;
          cursor: pointer;
          position: relative;
        }

        .notif-badge {
          position: absolute;
          top: -4px;
          right: -6px;
          background: #e53935;
          color: #fff;
          font-size: 12px;
          padding: 2px 6px;
          border-radius: 12px;
        }

        .notification-dropdown {
          display: none;
          position: absolute;
          right: 0;
          top: 42px;
          width: 320px;
          background: #fff;
          border-radius: 12px;
          border: 1px solid #e5e7eb;
          box-shadow: 0 1px 1px rgba(0, 0, 0, 0.02);
          z-index: 100;
        }

        .notification-dropdown.show {
          display: block;
        }

        .notif-header {
          padding: 14px;
          font-weight: 700;
          border-bottom: 1px solid #eee;
        }

        .notif-item {
          padding: 12px 14px;
          font-size: 14px;
          border-bottom: 1px solid #f2f2f2;
        }

        .notif-item.unread {
          background: #f0faf8;
          font-weight: 600;
        }

        .topbar-right {
          margin-left: auto;
        }

        /* ===== Flat section style (enterprise) ===== */
        .flat-section {
          margin-top: 32px;
        }

        .section-heading {
          font-size: 18px;
          font-weight: 600;
          color: #111827;
          margin-bottom: 16px;
        }

        /* ===== De-cardify inner content ===== */

        /* KPI cards ‚Äì keep accent */
        .kpi-card {
          box-shadow: none;
          border: 1px solid #e5e7eb;
          border-top: 3px solid var(--brand);
          border-radius: 10px;
        }

        /* Course cards ‚Äì neutral */
        .course-card {
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          box-shadow: none;
          background: #ffffff;
        }

        /* Generic cards ‚Äì flat */
        .card {
          border: 1px solid #e5e7eb;
          border-radius: 10px;
          box-shadow: none;
        }

        /* Remove rounded stacking feel */
        .card,
        .course-card {
          border-radius: 10px;
        }

        .flat-section {
          margin-top: 36px;
        }

        .section-heading {
          margin-bottom: 20px;
        }

        .section-subtext {
          font-size: 14px;
          font-weight: 500;
          color: #6b7280;
          margin-left: 8px;
        }

        .page-context {
          font-size: 14px;
          font-weight: 600;
          color: #374151;
        }

        .timeline-layout {
          display: grid;
          grid-template-columns: 280px 1fr;
          gap: 22px;
        }

        .timeline-left {
          border: 1px solid #e5e7eb;
          border-radius: 12px;
          padding: 14px;
          background: #fff;
          max-height: 70vh;
          overflow: auto;
        }

        .tree-group + .tree-group {
          margin-top: 14px;
        }

        .timeline-right {
          border: 1px solid #e5e7eb;
          border-radius: 12px;
          padding: 16px;
          background: #fff;
        }
        .timeline-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 12px;
          margin-bottom: 12px;
        }
        .timeline-header h3 {
          margin: 0;
          font-size: 18px;
          color: #111827;
          font-weight: 700;
        }
        .pill {
          font-size: 12px;
          padding: 4px 10px;
          border-radius: 999px;
          background: #f3f4f6;
          color: #374151;
          border: 1px solid #e5e7eb;
        }

        .timeline-table {
          width: 100%;
          border-collapse: collapse;
        }
        .timeline-table th,
        .timeline-table td {
          padding: 10px 8px;
          border-top: 1px solid #e5e7eb;
          vertical-align: middle;
          font-size: 14px;
        }
        .timeline-table th {
          color: #6b7280;
          font-size: 12px;
          text-transform: uppercase;
          letter-spacing: 0.2px;
          font-weight: 700;
        }
        .muted {
          color: #6b7280;
          font-size: 13px;
        }

        @media (max-width: 1100px) {
          .timeline-layout {
            grid-template-columns: 1fr;
          }
          .timeline-left {
            max-height: none;
          }


          .notification-wrapper {
              position: relative;
          }

          .notification-btn {
              background: none;
              border: none;
              cursor: pointer;
              position: relative;
          }

          .notif-badge {
              position: absolute;
              top: -4px;
              right: -6px;
              background: #e53935;
              color: #fff;
              font-size: 11px;
              padding: 2px 6px;
              border-radius: 12px;
          }

          .notification-dropdown {
              display: none;
              position: absolute;
              right: 0;
              top: 42px;
              width: 320px;
              background: #fff;
              border-radius: 12px;
              border: 1px solid #E5E7EB;
              box-shadow: 0 1px 1px rgba(0,0,0,0.02);
              z-index: 100;
          }

          .notification-dropdown.show {
              display: block;
          }

          .notif-header {
              padding: 14px;
              font-weight: 700;
              border-bottom: 1px solid #eee;
          }

          .notif-item {
              padding: 12px 14px;
              font-size: 14px;
              border-bottom: 1px solid #f2f2f2;
          }

          .notif-item.unread {
              background: #f0faf8;
              font-weight: 600;
          }

          .topbar-right {
              margin-left: auto;
          }

          /* ===== Flat section style (enterprise) ===== */
          .flat-section {
              margin-top: 32px;
          }

          .section-heading {
              font-size: 18px;
              font-weight: 600;
              color: #111827;
              margin-bottom: 16px;
          }


          /* ===== De-cardify inner content ===== */

          /* KPI cards ‚Äì keep accent */
          .kpi-card {
              box-shadow: none;
              border: 1px solid #E5E7EB;
              border-top: 3px solid var(--brand);
              border-radius: 10px;
          }

          /* Course cards ‚Äì neutral */
          .course-card {
              border: 1px solid #E5E7EB;
              border-radius: 8px;
              box-shadow: none;
              background: #FFFFFF;
          }

          /* Generic cards ‚Äì flat */
          .card {
              border: 1px solid #E5E7EB;
              border-radius: 10px;
              box-shadow: none;
          }


          /* Remove rounded stacking feel */
          .card,
          .course-card {
              border-radius: 10px;
          }

          .flat-section {
              margin-top: 36px;
          }

          .section-heading {
              margin-bottom: 20px;
          }

          .section-subtext {
              font-size: 13px;
              font-weight: 500;
              color: #6B7280;
              margin-left: 8px;
          }

          .page-context {
              font-size: 14px;
              font-weight: 600;
              color: #374151;
          }

          .dashboard-content {
              transition: transform 0.2s ease, box-shadow 0.2s ease;
          }

          .dashboard-content:hover {
              transform: translateY(-2px);
              box-shadow: 0 6px 18px rgba(0,0,0,0.08);
          }

        }

        /* ‚úÖ Inline chapters panel */
          .chapters-panel {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 18px;
          }

          .chapters-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 12px;
            margin-bottom: 14px;
          }

          .chapters-panel-header h2 {
            font-size: 18px;
            font-weight: 500;
            color: #111827;
          }

          .secondary-btn {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
          }

          .secondary-btn:hover {
            background: #e5e7eb;
          }

          .chapters-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 14px;
          }

          #chapterSearch {
            flex: 1;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            outline: none;
          }

          #chapterSearch:focus {
            border-color: #1eae98;
          }

          #chapterFilter {
            width: 160px;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            font-weight: 700;
          }

          /* ‚úÖ Chapters table */
          .chapters-table-wrap {
            overflow-x: auto;
          }

          .chapters-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
          }

          /* ============================
               ‚úÖ PRODUCTION CHAPTERS UI
            ============================ */

            .pro-panel {
              background: #ffffff;
              border: 1px solid #edf2f7;
              border-radius: 16px;
              padding: 18px;
              box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
            }

            .pro-header {
              margin-bottom: 14px;
            }

            /* Title */
            .pro-title{
              font-size: 20px;
            }

            /* Each chapter main title */
            .chapter-name{
              font-size: 15px;    /* was 14 */
              line-height: 1.3;
            }

            /* Deadline + status row */
            .chapter-meta{
              font-size: 14px;    /* was 12 */
              color: #64748b;
            }

            /* Deadline label */
            .chapter-meta span{
              font-weight: 500;
            }


            .pro-controls {
              display: flex;
              gap: 10px;
              align-items: center;
              margin-bottom: 14px;
            }

            #chapterSearch {
              flex: 1;
              border-radius: 12px;
              border: 1px solid #e5e7eb;
              padding: 10px 12px;
              font-size: 14px;
              background: #fafafa;
            }

            #chapterSearch:focus {
              outline: none;
              border-color: #14b8a6;
              background: #ffffff;
            }

            #chapterFilter {
              width: 150px;
              border-radius: 12px;
              border: 1px solid #e5e7eb;
              padding: 10px 12px;
              font-size: 14px;
              background: #fafafa;
              font-weight: 600;
            }

            .pro-close {
              border-radius: 12px;
              font-size: 13px;
              padding: 8px 12px;
              font-weight: 650;
            }

            /* ‚úÖ list container */
            .chapters-list {
              display: flex;
              flex-direction: column;
              gap: 10px;
            }

            /* ‚úÖ each row card */
            .chapter-row {
              display: grid;
              grid-template-columns: 1fr 140px;
              gap: 14px;
              padding: 14px 14px;
              border-radius: 14px;
              border: 1px solid #eef2f7;
              background: #ffffff;
              transition: 0.18s ease;
            }

            .chapter-row:hover {
              border-color: #dbeafe;
              box-shadow: 0 6px 20px rgba(15, 23, 42, 0.05);
              transform: translateY(-1px);
            }

            /* left */
            .chapter-main {
              display: flex;
              flex-direction: column;
              gap: 6px;
            }

            .chapter-name {
              font-size: 14px;
              font-weight: 600;
              color: #0f172a;
            }

            .chapter-meta {
              display: flex;
              flex-wrap: wrap;
              gap: 8px;
              align-items: center;
            }

            /* right */
            .chapter-action {
              display: flex;
              flex-direction: column;
              gap: 8px;
              align-items: flex-end;
              justify-content: center;
            }

            /* status pill subtle */
            .pro-pill {
              font-size: 12px;
              font-weight: 650;
              padding: 5px 10px;
              border-radius: 999px;
              border: 1px solid #e5e7eb;
              background: #f8fafc;
              color: #475569;
            }

            .pro-pill.open {
              background: #ecfdf5;
              border-color: #bbf7d0;
              color: #15803d;
            }

            .pro-pill.closed {
              background: #fef2f2;
              border-color: #fecaca;
              color: #b91c1c;
            }

            /* submit button more premium */
            .pro-submit {
              border-radius: 12px !important;
              padding: 8px 12px !important;
              font-size: 13px;
              font-weight: 650 !important;
              text-decoration: none;
            }

            /* on closed */
            .pro-disabled {
              opacity: 0.55;
              pointer-events: none;
            }

            .pro-submit{
              font-size: 14px;
              font-weight: 600 !important;
              padding: 9px 14px !important;
            }

        .course-title{
          font-size: 15px;
          font-weight: 700;
          color: #0f172a;
          margin-bottom: 8px;
        }

        .course-meta{
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
          margin-bottom: 10px;
        }

        .meta-pill{
          font-size: 12px;
          font-weight: 600;
          color: #334155;
          background: #f8fafc;
          border: 1px solid #e5e7eb;
          padding: 4px 10px;
          border-radius: 999px;
        }

        .course-subtext{
          font-size: 13px;
          color: #64748b;
          margin-bottom: 14px;
        }

        .course-context{
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
          margin-top: 8px;
        }

        .course-context .meta-pill{
          background: #ffffff;
        }

        .chapter-row{
          border-left: 4px solid #e5e7eb;
        }
        .chapter-row:hover{
          border-left-color: #1eae98;
        }

        .chapter-name{
          font-size: 15px;
          font-weight: 650;
        }

        .meta-pill{
          background: #f1f5f9;
          border: 1px solid #e2e8f0;
        }

        /* ‚úÖ Inline chapters animation */
        #inline-chapters-section {
          transform-origin: top center;
        }

        #inline-chapters-section.opening {
          display: block !important;
          animation: slideGrowIn 0.35s ease forwards;
        }

        #inline-chapters-section.closing {
          animation: slideGrowOut 0.25s ease forwards;
        }

        @keyframes slideGrowIn {
          from {
            opacity: 0;
            transform: translateY(-12px) scale(0.98);
          }
          to {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
        }

        @keyframes slideGrowOut {
          from {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
          to {
            opacity: 0;
            transform: translateY(-10px) scale(0.98);
          }
        }

        .course-card.active-course {
          border-color: #1eae98;
          box-shadow: 0 10px 30px rgba(30, 174, 152, 0.15);
          transform: translateY(-2px);
          transition: 0.25s ease;
        }

        .course-card {
          transition: 0.25s ease;
        }

        /* ‚úÖ Smooth expand like it came out of the card */
        #inline-chapters-section {
          margin-top: 14px;
          transform-origin: top;
        }

        #inline-chapters-section.opening {
          display: block !important;
          animation: expandFromCard 0.35s ease forwards;
        }

        #inline-chapters-section.closing {
          animation: collapseToCard 0.25s ease forwards;
        }

        @keyframes expandFromCard {
          from {
            opacity: 0;
            transform: translateY(-10px) scale(0.98);
          }
          to {
            opacity: 1;
            transform: translateY(0px) scale(1);
          }
        }

        @keyframes collapseToCard {
          from {
            opacity: 1;
            transform: translateY(0px) scale(1);
          }
          to {
            opacity: 0;
            transform: translateY(-8px) scale(0.98);
          }
        }

        .course-card-content {
          display: flex;
          flex-direction: column;
          gap: 10px;
        }

        .course-card-actions {
          margin-top: 18px;
        }

        .course-title {
          font-size: 16px;
          font-weight: 750;
          color: #0f172a;
        }

        .course-subtext {
          color: #64748b;
          font-size: 13px;
          line-height: 1.4;
        }

        .primary-btn {
          border-radius: 10px;
          padding: 10px 14px;
          font-weight: 650;
          transition: background 0.2s ease, transform 0.2s ease;
        }

        .primary-btn:hover {
          transform: translateY(-1px);
        }

        .course-card-actions {
          margin-top: 18px;
          display: flex;
          gap: 10px;
        }

        .course-card-actions .primary-btn {
          width: auto; /* ‚úÖ prevents full width */
        }

        /* ‚úÖ Make last card full width when it is alone in the last row */
        .course-grid > .course-card:last-child:nth-child(odd) {
          grid-column: 1 / -1; /* span full row */
        }

        .course-card-actions{
          margin-top: 18px;
          display: flex;
          gap: 10px;
          align-items: center;
        }

        .course-card-actions .primary-btn{
          border-radius: 10px;
          padding: 10px 14px;
          font-weight: 650;
        }

        .course-title{
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .course-icon{
          font-size: 14px;
          color: #0f766e; /* brand teal */
          opacity: 0.9;
        }

        .course-card-actions{
          margin-top: 18px;
          padding-top: 14px;
          border-top: 1px solid #eef2f7;  /* subtle divider */
          display: flex;
          gap: 10px;
          align-items: center;
        }

        .task-pill {
          display: inline-block;
          margin-left: 10px;
          font-size: 11px;
          font-weight: 700;
          padding: 4px 10px;
          border-radius: 999px;
          border: 1px solid #e5e7eb;
          background: #f8fafc;
          color: #475569;
        }

        .task-pill.red {
          background: #fef2f2;
          border-color: #fecaca;
          color: #b91c1c;
        }

        .task-pill.orange {
          background: #fff7ed;
          border-color: #fed7aa;
          color: #c2410c;
        }

        .task-pill.green {
          background: #ecfdf5;
          border-color: #bbf7d0;
          color: #15803d;
        }

        .task-pill {
          margin-left: 8px;
        }

        .notes-btn{
          background:#f9fafb;
          border:1px solid #e5e7eb;
          border-radius:999px;
          padding:8px 10px;
          cursor:pointer;
          font-size:14px;
        }
        .notes-btn:hover{
          background:#f3f4f6;
        }

        .notes-btn{
          display:flex;
          align-items:center;
          gap:8px;

          background:#fffdf6;                 /* sticky note vibe */
          border:1px solid #fde68a;           /* soft yellow border */
          border-radius:999px;
          padding:8px 12px;

          cursor:pointer;
          font-size:13px;
          font-weight:700;
          color:#92400e;

          transition: 0.2s ease;
        }

        .notes-btn i{
          font-size:16px;
          color:#f59e0b; /* sticky note icon color */
        }

        .notes-btn:hover{
          background:#fffbeb;
          transform: translateY(-1px);
        }

        .notes-text{
          display:inline-block;
        }

        @media(max-width:700px){
          .notes-text{ display:none; }   /* only icon on mobile */
        }

    </style>
</head>

<body>
<div class="dashboard-layout">
    {% include "contributor/sidebar.html" %}
    <!-- MAIN -->
    <main class="main-content">
        <!-- TOP BAR -->
        <div class="topbar">
            <div class="topbar-left">
                <span class="page-context">Contributor Dashboard</span>
            </div>

            <div class="topbar-right">
                <!-- üîî Notification Component -->
                <div class="notification-wrapper">
                    <button class="notification-btn" onclick="toggleNotifications()">
                        <i class="fas fa-bell notification-icon"></i>

                        {% if unread_count > 0 %}
                        <span class="notif-badge">{{ unread_count }}</span>
                        {% endif %}
                    </button>

                    <div class="notification-dropdown" id="notifDropdown">
                        <div class="notif-header">Notifications</div>

                        {% for notif in notifications %}
                        <div
                                class="notif-item {% if not notif.is_read %}unread{% endif %}"
                        >
                            <strong>{{ notif.title }}</strong>
                            <p>{{ notif.message }}</p>
                        </div>
                        {% empty %}
                        <div class="notif-item">No notifications</div>
                        {% endfor %}
                    </div>
                </div>

                <button class="notes-btn" onclick="openNotesModal()" title="Notes">
                    <i class="fa-solid fa-note-sticky"></i>
                    <span class="notes-text">Notes</span>
                </button>


                <!-- üë§ User -->
                <span class="user-chip"
                >{{ user.first_name }} {{ user.last_name }}</span
                >
            </div>
        </div>

        <div id="content-area">
            <!-- DASHBOARD -->
            <section id="dashboard-content" class="content-section active">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <h3>{{ uploads|length }}</h3>
                        <p>Total Contributions</p>

                    </div>
                    <div class="kpi-card">
                        <h3>{{ recommended_courses|length }}</h3>
                        <p>Recommended Subjects</p>
                    </div>
                </div>

                <section class="flat-section">
                    <h2 class="section-heading">
                        My Tasks ({{ tasks|length }})
                        <span class="section-subtext">Complete pending work & meet deadlines</span>
                    </h2>

                    <div class="card" style="padding:18px;">
                        {% if tasks %}
                        <ul style="display:flex; flex-direction:column; gap:12px;">
                            {% for t in tasks %}
                            <li style="display:flex; justify-content:space-between; align-items:center; gap:14px; padding:12px 14px; border:1px solid #eef2f7; border-radius:12px; background:#fff;">
                                <div>
                                    <div style="font-weight:700; color:#0f172a;">
                                        {% if t.type == "deadline" %}‚è≥{% else %}‚úÖ{% endif %}
                                        {{ t.title }}

                                        {% if t.type == "deadline" %}
                                        <span class="task-pill {{ t.urgency }}">
                                                    {{ t.urgency_text }}
                                                </span>
                                        {% endif %}
                                    </div>

                                    <div class="muted" style="margin-top:3px;">
                                        {{ t.subtitle }}
                                    </div>
                                </div>

                                <a class="primary-btn"
                                   style="text-decoration:none;"
                                   href="/dashboard/contributor/submit_content/?course_id={{ t.course_id }}&chapter_id={{ t.chapter_id }}">
                                    Open
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <div class="muted">No pending tasks üéâ</div>
                        {% endif %}
                    </div>
                </section>

                <section class="flat-section">
                    <h2 class="section-heading">
                        Recommended Subjects
                        <span class="section-subtext">Based on your expertise</span>
                    </h2>

                    <div class="course-grid">
                        {% for course in recommended_courses %}
                        <div class="course-card"
                             data-course-id="{{ course.id }}"
                             data-course-name="{{ course.course_name }}"
                             data-course-year="{{ course.year_of_study }}"
                             data-course-sem="{{ course.semester }}">

                            <div class="course-card-content">
                                <h4 class="course-title">
                                    <i class="fa-solid fa-book-open course-icon"></i>
                                    {{ course.course_name }}
                                </h4>

                                <div class="course-meta">
                                    <span class="meta-pill">{{ course.course_code }}</span>
                                    <span class="meta-pill">{{ course.scheme.name }}</span>
                                    <span class="meta-pill">{{ course.department.dept_name }}</span>
                                    <span class="meta-pill">{{ course.department.program.program_name }}</span>

                                    {% if course.year_of_study %}
                                    <span class="meta-pill">{{ course.year_of_study }}</span>
                                    {% endif %}

                                    {% if course.semester %}
                                    <span class="meta-pill">Sem {{ course.semester }}</span>
                                    {% endif %}
                                </div>

                                <p class="course-subtext">
                                    Curriculum aligned subject ‚Ä¢ Submit chapter wise contributions
                                </p>
                            </div>

                            <div class="course-card-actions">
                                <button
                                        class="primary-btn view-chapters-btn"
                                        data-course-id="{{ course.id }}"
                                        data-course-name="{{ course.course_name }}"
                                >
                                    Browse Chapters
                                </button>

                                <button class="primary-btn view-opened-btn" style="display:none;" disabled>
                                    Viewing Chapters...
                                </button>
                            </div>

                        </div>
                        {% empty %}
                        <p>No recommendations available.</p>
                        {% endfor %}
                    </div>

                    <section class="flat-section">
                        <h2 class="section-heading">
                            Recent Activity
                            <span class="section-subtext">Your latest actions</span>
                        </h2>

                        <div class="card" style="padding:18px;">
                            {% if recent_activity %}
                            <ul style="display:flex; flex-direction:column; gap:12px;">
                                {% for a in recent_activity %}
                                <li style="display:flex; justify-content:space-between; align-items:center; gap:14px; padding:12px 14px; border:1px solid #eef2f7; border-radius:12px; background:#fff;">

                                    <div style="display:flex; gap:12px; align-items:flex-start;">
                                        <div style="font-size:16px;">{{ a.icon }}</div>

                                        <div>
                                            <div style="font-weight:700; color:#0f172a;">
                                                {{ a.text }}
                                            </div>
                                            <div class="muted" style="margin-top:3px;">
                                                {{ a.time|date:"d M Y, h:i A" }}
                                            </div>
                                        </div>
                                    </div>

                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <div class="muted">No recent activity yet.</div>
                            {% endif %}
                        </div>
                    </section>

                </section>

            </section>
        </div>

        <section class="flat-section" id="inline-chapters-section" style="display:none;">
            <div class="chapters-panel pro-panel">
                <div class="chapters-panel-header pro-header">
                    <div>
                        <h2 id="inline-course-title" class="pro-title">Chapters</h2>
                        <p class="muted" id="inline-course-subtitle">
                            Select a subject above to view chapters
                        </p>

                        <div class="course-context" id="inline-course-context"></div>

                    </div>

                    <button class="secondary-btn pro-close" id="close-inline-panel">
                        Close
                    </button>
                </div>

                <div class="chapters-controls pro-controls">
                    <input
                            type="text"
                            id="chapterSearch"
                            placeholder="Search chapters..."
                    />

                    <select id="chapterFilter">
                        <option value="all">All</option>
                        <option value="open">Open</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>

                <!-- ‚úÖ NEW LIST VIEW -->
                <div class="chapters-list" id="chaptersList">
                    <!-- JS will render chapters here -->
                </div>
            </div>
        </section>

    </main>
</div>

<div class="modal-overlay" id="notesModal">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
            <h3 style="font-size:18px; font-weight:700;">My Notes</h3>
            <button onclick="closeNotesModal()" style="border:none; background:none; font-size:18px; cursor:pointer;">‚úñ</button>
        </div>

        <!-- Add note -->
        <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:14px;">
            <input id="noteTitle" placeholder="Title (optional)"
                   style="padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px;">
            <textarea id="noteContent" placeholder="Write a note..."
                      style="padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; min-height:90px;"></textarea>

            <button class="primary-btn" id="noteSaveBtn" onclick="saveNote()">Add Note</button>
            <button class="secondary-btn" id="cancelEditBtn" onclick="cancelEdit()" style="display:none;">
                Cancel
            </button>
            <input type="hidden" id="editingNoteId">
        </div>

        <!-- Notes list -->
        <div id="notesList" style="display:flex; flex-direction:column; gap:10px;">
            {% if notes %}
            {% for n in notes %}
            <div style="border:1px solid #eef2f7; border-radius:12px; padding:12px;">
                <div style="font-weight:700; color:#0f172a;">
                    {{ n.title|default:"Untitled" }}
                </div>
                <div class="muted" style="margin-top:4px;">
                    {{ n.content }}
                </div>

                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="secondary-btn" onclick="editNote('{{n.id}}','{{n.title|escapejs}}','{{n.content|escapejs}}')">
                        Edit
                    </button>

                    <button class="secondary-btn" style="border-color:#fecaca; background:#fef2f2; color:#b91c1c;"
                            onclick="deleteNote('{{n.id}}')">
                        Delete
                    </button>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="muted">No notes yet.</div>
            {% endif %}
        </div>
    </div>
</div>

<script id="chapters-data" type="application/json">
    {{ chapters_json|safe }}
</script>


<script>
    function toggleNotifications() {
      document.getElementById("notifDropdown").classList.toggle("show");
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {

      const chaptersData = JSON.parse(
        document.getElementById("chapters-data")?.textContent || "{}"
      );

      const section = document.getElementById("inline-chapters-section");
      const courseTitle = document.getElementById("inline-course-title");
      const subtitle = document.getElementById("inline-course-subtitle");
      const courseContext = document.getElementById("inline-course-context");

      const searchInput = document.getElementById("chapterSearch");
      const filterSelect = document.getElementById("chapterFilter");
      const closePanelBtn = document.getElementById("close-inline-panel");

      const list = document.getElementById("chaptersList");

      let currentCourseId = null;
      let activeCard = null;

      // ‚úÖ Deadline formatter
      function formatDeadline(deadlineStr) {
        if (!deadlineStr) return "‚Äî";

        const d = new Date(deadlineStr);

        return d.toLocaleString("en-IN", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true
        });
      }

      // ‚úÖ Render chapters based on search/filter
      function renderChapters() {
        if (!currentCourseId) return;

        const chapters = chaptersData[currentCourseId] || [];
        const query = (searchInput.value || "").toLowerCase().trim();
        const filter = filterSelect.value;

        list.innerHTML = "";

        let filtered = chapters.filter((ch) => {
          const text = `${ch.chapter_number} ${ch.chapter_name}`.toLowerCase();
          if (query && !text.includes(query)) return false;

          if (filter === "open") return ch.deadline && ch.is_open === true;
          if (filter === "closed") return ch.deadline && ch.is_open === false;
          return true;
        });

        filtered.sort((a, b) => a.chapter_number - b.chapter_number);

        if (filtered.length === 0) {
          list.innerHTML = `<div class="muted" style="padding:10px 4px;">No matching chapters found.</div>`;
          return;
        }

        filtered.forEach((ch) => {
          const hasDeadline = !!ch.deadline;
          const isClosed = !hasDeadline || (hasDeadline && ch.is_open === false);

          // ‚úÖ Deadline text
          let deadlineText = "Deadline: ‚Äî";
          if (hasDeadline) {
            deadlineText = `Deadline: ${formatDeadline(ch.deadline)}`;
          }

          // ‚úÖ Status pill
          let statusClass = "Closed";
          let statusText = "No deadline";

          if (hasDeadline && ch.is_open === true) {
            statusClass = "open";
            statusText = "Open";
          } else if (hasDeadline && ch.is_open === false) {
            statusClass = "closed";
            statusText = "Closed";
          }

          let buttonText = "Start"; // or "Submit"
            let closedMsg = "";
            let lockBecauseSubmitted = false;

            // ‚úÖ if already submitted
            if (ch.submitted === true) {
              buttonText = "Submitted";
              lockBecauseSubmitted = true;
            } else {
              // ‚úÖ if uploads exist, resume
              if ((ch.total_uploads || 0) > 0) {
                buttonText = "Resume";
              }
            }

            // keep your closed logic too
            if (!hasDeadline) {
              buttonText = "Not open";
              closedMsg = `
                <div class="muted" style="font-size:12px; margin-top:4px;">
                  Contributions are currently not being accepted for this chapter
                </div>
              `;
            } else if (hasDeadline && ch.is_open === false) {
              buttonText = "Closed";
              closedMsg = `
                <div class="muted" style="font-size:12px; margin-top:4px;">
                  Contributions are closed for this chapter
                </div>
              `;
            }

            // ‚úÖ disable if chapter closed OR submitted
            const isLocked = isClosed || lockBecauseSubmitted;


          const row = document.createElement("div");
          row.className = "chapter-row";

          row.innerHTML = `
            <div class="chapter-main">
              <div class="chapter-name">
                Chapter ${ch.chapter_number}: ${ch.chapter_name}
              </div>

              <div class="chapter-meta">
                <span>${deadlineText}</span>
                <span class="pro-pill ${statusClass}">${statusText}</span>
              </div>

              ${closedMsg}
            </div>

            <div class="chapter-action">
              <a class="primary-btn pro-submit ${isLocked ? "pro-disabled" : ""}"
               ${isLocked ? "" : `href="/dashboard/contributor/submit_content/?course_id=${currentCourseId}&chapter_id=${ch.id}"`}>
              ${buttonText}
            </a>
            </div>
          `;

          list.appendChild(row);
        });
      }

      // ‚úÖ Open inline chapters panel
      function openInlineChapters(courseId, courseName, meta, cardEl) {
        currentCourseId = String(courseId);

        courseTitle.textContent = `Chapters for ${courseName}`;
        subtitle.textContent = "Search and submit chapter-wise contributions";

        // ‚úÖ only year + sem
        courseContext.innerHTML = `
          ${meta.year ? `<span class="meta-pill">${meta.year}</span>` : ""}
          ${meta.sem ? `<span class="meta-pill">Sem ${meta.sem}</span>` : ""}
        `;

        // ‚úÖ reset old active card
        if (activeCard) {
          activeCard.classList.remove("active-course");

          const oldBrowse = activeCard.querySelector(".view-chapters-btn:not(.view-opened-btn)");
          const oldOpened = activeCard.querySelector(".view-opened-btn");

          if (oldBrowse) oldBrowse.style.display = "inline-block";
          if (oldOpened) oldOpened.style.display = "none";
        }

        // ‚úÖ set new active card
        activeCard = cardEl;
        activeCard.classList.add("active-course");

        const browseBtn = activeCard.querySelector(".view-chapters-btn:not(.view-opened-btn)");
        const openedBtn = activeCard.querySelector(".view-opened-btn");

        if (browseBtn) browseBtn.style.display = "none";
        if (openedBtn) openedBtn.style.display = "inline-block";

        // ‚úÖ open panel animation
        section.style.display = "block";
        section.classList.remove("closing");
        section.classList.add("opening");

        searchInput.value = "";
        filterSelect.value = "all";

        renderChapters();

        setTimeout(() => {
          section.scrollIntoView({ behavior: "smooth", block: "start" });
        }, 80);

        setTimeout(() => {
          section.classList.remove("opening");
        }, 400);
      }

      // ‚úÖ Browse Chapters click
      document.body.addEventListener("click", function (e) {
        const btn = e.target.closest(".view-chapters-btn:not(.view-opened-btn)");
        if (!btn) return;

        const card = btn.closest(".course-card");
        if (!card) return;

        openInlineChapters(
          btn.dataset.courseId,
          btn.dataset.courseName,
          {
            year: card.dataset.courseYear || "",
            sem: card.dataset.courseSem || ""
          },
          card
        );
      });

      // ‚úÖ Search + Filter
      searchInput.addEventListener("input", renderChapters);
      filterSelect.addEventListener("change", renderChapters);

      // ‚úÖ Close panel
      closePanelBtn.addEventListener("click", function () {
        section.classList.remove("opening");
        section.classList.add("closing");

        setTimeout(() => {
          section.style.display = "none";
          section.classList.remove("closing");

          currentCourseId = null;
          list.innerHTML = "";

          if (activeCard) {
            activeCard.classList.remove("active-course");

            const browseBtn = activeCard.querySelector(".view-chapters-btn:not(.view-opened-btn)");
            const openedBtn = activeCard.querySelector(".view-opened-btn");

            if (browseBtn) browseBtn.style.display = "inline-block";
            if (openedBtn) openedBtn.style.display = "none";

            activeCard = null;
          }
        }, 250);
      });

    });
</script>

<script>
    function openNotesModal(){
      document.body.classList.add("modal-open");
      document.getElementById("notesModal").style.visibility = "visible";
      document.getElementById("notesModal").style.opacity = "1";
    }

    function closeNotesModal(){
      document.body.classList.remove("modal-open");
      document.getElementById("notesModal").style.visibility = "hidden";
      document.getElementById("notesModal").style.opacity = "0";
    }

    document.getElementById("notesModal").addEventListener("click", function(e){
    if(e.target.id === "notesModal"){
      closeNotesModal();
    }
  });
</script>

<script>
    async function addNote(){
      const title = document.getElementById("noteTitle").value;
      const content = document.getElementById("noteContent").value;

      const formData = new FormData();
      formData.append("title", title);
      formData.append("content", content);

      const res = await fetch("/dashboard/contributor/notes/add/", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      if(data.success){
        location.reload();
      } else {
        alert(data.error || "Failed to add note");
      }
    }

      function editNote(id, title, content){
        document.getElementById("editingNoteId").value = id;
        document.getElementById("noteTitle").value = title || "";
        document.getElementById("noteContent").value = content || "";

        document.getElementById("noteSaveBtn").innerText = "Update Note";
        document.getElementById("cancelEditBtn").style.display = "inline-block";
      }

      function cancelEdit(){
        document.getElementById("editingNoteId").value = "";
        document.getElementById("noteTitle").value = "";
        document.getElementById("noteContent").value = "";

        document.getElementById("noteSaveBtn").innerText = "Add Note";
        document.getElementById("cancelEditBtn").style.display = "none";
      }

      async function saveNote(){
        const noteId = document.getElementById("editingNoteId").value;
        const title = document.getElementById("noteTitle").value;
        const content = document.getElementById("noteContent").value;

        if(!content.trim()){
          alert("Note content cannot be empty");
          return;
        }

        const formData = new FormData();
        formData.append("title", title);
        formData.append("content", content);

        let url = "/dashboard/contributor/notes/add/";
        if(noteId){
          url = `/dashboard/contributor/notes/edit/${noteId}/`;
        }

        const res = await fetch(url, {
          method: "POST",
          body: formData
        });

        const data = await res.json();

        if(data.success){
          location.reload();
        } else {
          alert(data.error || "Failed to save note");
        }
    }

    function deleteNote(id){
      if(!confirm("Delete this note?")) return;

      fetch(`/dashboard/contributor/notes/delete/${id}/`, {
        method: "POST"
      }).then(() => location.reload());
    }
</script>

</body>
</html>
