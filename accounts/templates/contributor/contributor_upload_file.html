{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Content</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tinymce@6/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        :root {
          --text-primary: #1f2937;   /* softer than pure black */
          --text-secondary: #6b7280;
          --text-muted: #9ca3af;

          --brand: #1EAE98;
          --brand-soft: #e6f8f7;

          --border-light: #e5e7eb;
          --bg-soft: #f9fafb;
        }

        /* Reset & Base Styles */

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }

        body { background-color: #FFFFFF; color: var(--text-primary); display: flex; min-height: 100vh; }

        a { text-decoration: none; color: inherit; }

        ul { list-style: none; }



        /* ADDED: Ensures the layout wrapper fills the page */

        .dashboard-layout {

            width: 100%;

        }



        /* --- MODIFIED MAIN CONTENT AREA --- */

        .main-content {

            flex-grow: 1;

            /* MODIFIED: Better padding for a full-width look */

            padding: 40px 60px;

            /* REMOVED: margin-left: 260px; */

        }

        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }



        /* MODIFIED: Made title bigger and bolder */

        .main-header h1 {

            font-size: 2.25rem; /* ~36px */

            font-weight: 700;

            color: #222;

        }

        .back-link { display: inline-flex; align-items: center; gap: 5px; color: #555; font-weight: 500; transition: color 0.2s; }

        .back-link:hover { color: #1EAE98; }

        /* --- END OF MODIFICATION --- */





        /* Cards */

        .card {

            background-color: #ffffff; border-radius: 12px; padding: 25px 30px;

            margin-bottom: 30px;

            /* MODIFIED: A slightly softer, more modern shadow */

            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.06);

            opacity: 0; transform: translateY(20px); animation: fadeInCard 0.5s ease-out forwards;

        }

        .card-title {

            font-size: 20px; color: var(--text-primary); margin-bottom: 20px;

            padding-bottom: 10px; border-bottom: 1px solid #eee;

        }



        /* --- Context Card Styles --- */

        .context-info p { font-size: 16px; margin-bottom: 10px; color: #555; }

        .context-info strong { color: #111827; font-weight: 600; }

        .context-info .topic-name { font-size: 18px; color: #000; margin-top: 15px; }



        /* --- TinyMCE Editor Section Styles --- */

        .filename-label { font-weight: 600; display: block; margin-bottom: 5px; color: #333; }

        .filename-input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 15px; }

        .editor-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }



        /* --- File Upload Section Styles --- */

        .upload-section label {

            display: block; font-weight: 600; color: #333; margin-bottom: 10px; font-size: 16px;

        }

        .upload-zones-container { display: flex; gap: 20px; margin-bottom: 20px; }

        .upload-zones-container .upload-area { flex: 1; }

        .file-drop-zone {

            background-color: #fafafa;
            border: 2px dashed #d1d5db; border-radius: 8px; padding: 25px;

            text-align: center; background-color: #f8fefd;

            cursor: pointer; transition: background-color 0.2s, border-color 0.2s;

        }

        .file-drop-zone.dragover { background-color: #ffffff; border-color: #1EAE98; }

        .file-drop-zone i { font-size: 30px; color: #6b7280; margin-bottom: 10px; }

        .file-drop-zone p { color: #555; margin-bottom: 15px; font-size: 14px;}

        .file-drop-zone .browse-btn {

            display: inline-block; padding: 8px 15px; background: linear-gradient(
                135deg,
                var(--brand),
                #178d79
            );

            color: white; border-radius: 6px; font-weight: 500; font-size: 14px;

        }

       .file-drop-zone input[type="file"] { display: none; }

        #upload-file-list {

            margin-top: 20px; margin-bottom: 20px; font-size: 14px; color: #333;

            text-align: left; max-height: 200px; overflow-y: auto;

        }

        #upload-file-list .file-item {

            background-color: #eef1f1; padding: 8px 12px; border-radius: 4px;

            margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;

            opacity: 0; transform: translateY(-10px); animation: slideDownFile 0.3s ease-out forwards;

        }

        #upload-file-list .file-details { display: flex; align-items: center; gap: 8px; }

        #upload-file-list .file-icon { color: #555; width: 15px; text-align: center;}

        #upload-file-list .remove-file-btn { background: none; border: none; color: #e74c3c; cursor: pointer; font-weight: bold; font-size: 16px;}

        .submit-button {

             background: #1EAE98; color: white; padding: 12px 25px; border: none;

             border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;

             transition: background-color 0.2s;

        }

        .submit-button:hover { background: #178D79; }



        /* --- Assessment Form Styles --- */

        .assessment-card { background-color: #fdfdff; border-left: 5px solid #6c757d; }

        .question-block {

            padding: 15px; border: 1px solid #eee; border-radius: 8px;

            margin-bottom: 20px; background: #fff;

        }

        .question-block label { font-weight: 600; color: #333; margin-bottom: 10px; display: block; }

        .question-block textarea, .question-block input[type="text"], .question-block select {

            width: 100%; padding: 10px; border-radius: 6px;

            border: 1px solid #ccc; margin-bottom: 10px;

            font-size: 15px; font-family: 'Segoe UI', sans-serif;

        }

        .options-container { display: flex; flex-direction: column; gap: 8px; }

        .add-option-btn, #addQuestionBtn {

            background-color: #eef1f1; border: 1px solid #ddd; color: #333;

            padding: 8px 12px; border-radius: 6px; cursor: pointer;

            font-weight: 500; margin-top: 10px; transition: background-color 0.2s;

        }

        .add-option-btn:hover, #addQuestionBtn:hover { background-color: #e0e0e0; }

        .submit-button-container { text-align: right; margin-top: 20px; }



        /* --- Final Submission Button --- */

        .final-submission-section { text-align: center; padding-top: 20px; border-top: 1px dashed #ccc; }

        .final-submit-button {

            display: inline-flex; align-items: center; justify-content: center;

            padding: 12px 30px; border: none; border-radius: 25px;

            background-color: #28a745; color: white;

            font-size: 16px; font-weight: bold; cursor: pointer;

      transition: background-color 0.2s, transform 0.1s;

        }

        .final-submit-button i { margin-right: 8px; }

        .final-submit-button:hover { background-color: #218838; transform: translateY(-2px); }



        /* --- Chatbot Styles --- */

        .chatbot-btn {

            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;

            background-color: #1EAE98; color: white; border: none; border-radius: 50%;

            font-size: 24px; display: flex; align-items: center; justify-content: center;

            cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);

            z-index: 998; transition: background-color 0.2s, transform 0.2s;

        }

        .chatbot-btn:hover { background-color: #178D79; transform: scale(1.05); }

        .chat-panel {

            position: fixed; top: 0; left: 0; width: 400px; max-width: 90%;

            height: 100%; background-color: #ffffff;

            box-shadow: 2px 0 15px rgba(0,0,0,0.1);

            display: flex; flex-direction: column;

            transform: translateX(-100%); transition: transform 0.4s ease-in-out;

            z-index: 1000;

        }

        .chat-header {

            display: flex; justify-content: space-between; align-items: center;

            padding: 15px 20px; background-color: #1EAE98; color: white;

            flex-shrink: 0;

        }

        .chat-header h3 { font-size: 18px; margin: 0; }

        .chat-close-btn {

            font-size: 28px; color: white; background: none;

            border: none; cursor: pointer; line-height: 1; opacity: 0.8;

        }

        .chat-close-btn:hover { opacity: 1; }

        .chat-messages {

            flex-grow: 1; padding: 20px; overflow-y: auto; background-color: #f9f9f9;

        }

        .message {

            margin-bottom: 15px; padding: 10px 15px; border-radius: 12px;

            max-width: 85%; line-height: 1.5;

        }

        .message.user { background-color: #e6f8f7; color: #333; margin-left: auto; border-bottom-right-radius: 4px; }

        .message.bot { background-color: #eef1f1; color: #444; margin-right: auto; border-bottom-left-radius: 4px; }

        .chat-input-area {

            display: flex; padding: 15px 20px; border-top: 1px solid #eee;

            background-color: #fff; flex-shrink: 0;

        }

        .chat-input-area input {

            flex-grow: 1; padding: 10px 15px; border: 1px solid #ccc;

            border-radius: 20px; margin-right: 10px; font-size: 15px;

        }

        .chat-input-area button {

            background-color: #1EAE98; color: white; border: none;

            border-radius: 50%; width: 40px; height: 40px;

            font-size: 18px; cursor: pointer; transition: background-color 0.2s;

         flex-shrink: 0;

        }

        .chat-input-area button:hover { background-color: #178D79; }

        .overlay {

            position: fixed; top: 0; left: 0; width: 100%; height: 100%;

            background-color: rgba(0, 0, 0, 0.5); z-index: 999;

            opacity: 0; visibility: hidden;

          	 transition: opacity 0.4s ease-in-out, visibility 0s 0.4s linear;

        }

        body.chat-open .chat-panel { transform: translateX(0); }

        body.chat-open .overlay { opacity: 1; visibility: visible; transition-delay: 0s; }

        .button-outline {
            background: transparent;
            border: 1px solid #d1d5db;
            color: #374151;
        }


        /* --- ANIMATIONS --- */

        @keyframes fadeInCard { to { opacity: 1; transform: translateY(0); } }

  .context-card { animation-delay: 0.1s; }

        .editor-card { animation-delay: 0.2s; }

        .upload-card { animation-delay: 0.3s; }

      	 @keyframes slideDownFile { to { opacity: 1; transform: translateY(0); } }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            gap: 32px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 4px;
            font-size: 15px;
            font-weight: 500;
            color: #6b7280;
            position: relative;
            transition: color 0.2s ease;
        }

        .tab:hover {
            color: #111827;
        }

        .tab.active {
            color: #1EAE98;
            font-weight: 600;
        }

        .tab.active::after {
            content: "";
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #1EAE98;
            border-radius: 3px 3px 0 0;
        }

        /* ===== Compact Submission Context (Breadcrumb-like) ===== */
        .submission-context {
            margin-bottom: 28px;
            padding: 12px 16px;
            background-color: #f8fafc; /* subtle, neutral */
            border: 1px solid #e5e7eb;
            border-radius: 10px;
        }

        .context-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #9ca3af;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .context-path {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .context-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .context-item i {
            font-size: 13px;
            color: #9ca3af;
        }

        .context-item.topic {
            font-weight: 600;
            color: #111827;
        }

        .separator {
            font-size: 11px;
            color: #9ca3af;
        }
        .submit-button {
            background: var(--brand);
            color: white;
        }

        .secondary-column .card {
          box-shadow: 0 2px 10px rgba(0,0,0,0.04);
          border: 1px solid var(--border-light);
        }


        /* ===== Two Column Content Layout ===== */
        .content-layout {
            display: grid;
            grid-template-columns: 2fr 1fr; /* ~65% / 35% */
            gap: 30px;
            align-items: stretch;
            overflow: hidden;
        }

        .primary-column,
        .secondary-column {
          overflow-y: auto;
          padding-right: 6px;
        }


        .primary-column .card {
          border: 1px solid var(--border-light);
        }


        .primary-column {
            min-width: 0; /* prevents editor overflow */
        }

        .secondary-column {
            position: sticky;
            top: 20px; /* keeps files visible while writing */
        }

        .primary-column,
        .secondary-column {
          display: flex;
          flex-direction: column;
        }

        .primary-column .editor-card {
          flex: 1;
          display: flex;
          flex-direction: column;
        }


        .secondary-column h3 {
          font-size: 14px;
          color: var(--text-secondary);
          margin-bottom: 8px;
        }

        .editor-card form {
          flex: 1;
          display: flex;
          flex-direction: column;
        }

        #editor {
          flex: 1;
        }


        .btn {
          padding: 10px 18px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s ease;
        }

        .btn-primary {
          background: var(--brand);
          color: white;
          border: none;
        }

        .btn-primary:hover {
          background: #178d79;
        }

        /* ===== ADHYAYAN PRIMARY GRADIENT BUTTON ===== */
        .btn-gradient {
            background: linear-gradient(
                135deg,
                var(--brand),
                #178d79
            );

            color: white;
            border: none;

            padding: 12px 22px;
            border-radius: 10px;

            font-size: 14px;
            font-weight: 600;

            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;

            cursor: pointer;
            transition: all .25s ease;
        }

        /* Hover */
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(30,174,152,.35);
        }

        /* Click feel */
        .btn-gradient:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(30,174,152,.25);
        }

        .btn-secondary {
          background: #ffffff;
          color: var(--text-primary);
          border: 1px solid var(--border-light);
        }

        .btn-secondary:hover {
          background: var(--bg-soft);
        }

        .btn-secondary.important {
          border: 1.5px solid #cbd5e1;
          font-weight: 600;
        }

        .delete-icon-btn {
          background: transparent;
          border: none;
          color: #9ca3af;
          cursor: pointer;
          padding: 4px;
        }

        .delete-icon-btn:hover {
          color: #ef4444; /* red-500 */
        }

        .btn-sm {
          padding: 6px 14px;
          font-size: 14px;
          border-radius: 6px;
        }

        .context-item.link-item {
            color: #374151;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .context-item.link-item:hover {
            color: var(--brand);
            text-decoration: underline;
        }

        /* Files card specific */
        .files-card {
            display: flex;
            flex-direction: column;
        }

        /* Scrollable area */
        .files-scroll-container {
            max-height: 360px;        /* adjust: 300â€“450px ideal */
            overflow-y: auto;
            padding-right: 6px;      /* space for scrollbar */
        }

        /* Nice scrollbar (Chrome, Edge) */
        .files-scroll-container::-webkit-scrollbar {
            width: 6px;
        }

        .files-scroll-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }

        .files-scroll-container::-webkit-scrollbar-thumb:hover {
            background-color: #9ca3af;
        }

        /* âœ… Expandable Guidelines (accordion) */
        .guidelines-card {
          padding: 18px 20px;
          border: 1px solid var(--border-light);
          background: #ffffff;
          border-radius: 12px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.04);
        }

        .guidelines-toggle {
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 12px;

          background: transparent;
          border: none;
          cursor: pointer;

          padding: 0;
        }

        .guidelines-title {
          display: flex;
          align-items: center;
          gap: 10px;

          font-size: 15px;
          font-weight: 650;
          color: var(--text-primary);
        }

        .guidelines-title i {
          color: var(--brand);
          font-size: 15px;
        }

        .guidelines-toggle .arrow {
          font-size: 14px;
          color: #64748b;
          transition: transform 0.25s ease;
        }

        .guidelines-body {
          margin-top: 14px;
          padding-top: 14px;
          border-top: 1px solid #eef2f7;

          display: none;
        }

        .guidelines-body.show {
          display: block;
          animation: fadeGuidelines 0.22s ease;
        }

        @keyframes fadeGuidelines {
          from {
            opacity: 0;
            transform: translateY(-4px);
          }
          to {
            opacity: 1;
            transform: translateY(0px);
          }
        }

        .guideline-list {
          display: flex;
          flex-direction: column;
          gap: 10px;
        }

        .guideline-item {
          display: flex;
          gap: 10px;
          align-items: flex-start;

          font-size: 13.5px;
          color: var(--text-secondary);
          line-height: 1.5;
        }

        .guideline-item i {
          margin-top: 3px;
          color: var(--brand);
          font-size: 12px;
        }

        .guideline-note {
          margin-top: 12px;
          font-size: 13px;
          color: #64748b;
          background: #f8fafc;
          border: 1px dashed #cbd5e1;
          padding: 10px 12px;
          border-radius: 10px;
        }

        #chat-attach-btn {
          background: #eef1f1 !important;
          color: #374151 !important;
          border: 1px solid #d1d5db !important;
        }

        #chat-attach-btn:hover {
          background: #e5e7eb !important;
        }

        #chat-attach-btn i {
          color: #374151 !important;
        }

        .chat-input-area {
          display: flex;
          gap: 10px;
          padding: 15px 20px;
          border-top: 1px solid #eee;
          background-color: #fff;
          align-items: center;
        }

        .submission-banner{
            display:flex;
            align-items:center;
            gap:10px;

            margin:18px 0 28px 0;
            padding:12px 16px;

            background:#fffbeb;
            border:1px solid #fde68a;
            border-left:5px solid #f59e0b;

            border-radius:10px;

            font-size:14px;
            color:#92400e;
        }

        .submission-banner i{
            color:#f59e0b;
            font-size:16px;
        }

        .ai-chip{
            display:inline-flex;
            align-items:center;
            gap:6px;

            padding:6px 12px;

            font-size:13px;
            font-weight:600;

            color:#0f766e;
            background:#ecfdf5;

            border:1px solid #bbf7d0;
            border-radius:999px;

            cursor:pointer;
            white-space:nowrap;

            transition:all .2s ease;
        }

        .ai-chip:hover{
            background:#d1fae5;
        }

        .ai-feedback{
            display:none;
            margin-top:16px;
            padding:14px 16px;

            background:#f8fafc;
            border:1px solid #e5e7eb;
            border-left:4px solid #1EAE98;

            border-radius:10px;
            font-size:14px;
        }

        .guidelines-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:16px;
        }

        /* IMPORTANT */
        .guidelines-toggle{
            min-width:0;   /* remove 100% */
            flex:1;
        }


        /* ===== Assessment Workspace ===== */

        .assessment-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .assessment-primary {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .assessment-secondary {
            position: sticky;
            top: 20px;
        }

        .pdf-select-row{
            display:flex;
            gap:10px;
            align-items:center;
            padding:10px;
            border:1px solid #e5e7eb;
            border-radius:8px;
            margin-bottom:8px;
            cursor:pointer;
            transition:all .2s;
        }

        .pdf-select-row:hover{
            background:#f9fafb;
        }

        .assessment-item{
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:14px;
            border:1px solid #e5e7eb;
            border-radius:10px;
        }

        .assessment-meta{
            font-size:13px;
            color:#6b7280;
        }

        .empty-state{
            padding:18px;
            border:1px dashed #cbd5e1;
            border-radius:8px;
            text-align:center;
            color:#64748b;
        }

        .assessment-layout .card-title{
            font-size:16px;
            font-weight:600;
            color:#111827;

            margin-bottom:14px;
            padding-bottom:8px;

            border-bottom:1px solid #f1f5f9;
        }

        .assessment-layout .card-title i{
            font-size:14px;
            opacity:0.7;
            margin-right:6px;
        }

        .assessment-layout .card-title{
            display:flex;
            align-items:center;
            gap:8px;
        }

        /* ===============================
           ASSESSMENT TAB POLISH
        =================================*/

        /* workspace breathing */
        .assessment-primary .card{
            padding:22px 26px;
        }

        /* ---------- TITLE ICON COLORS ---------- */
        .card-title i{
            color:#1EAE98;
        }

        .card-title .fa-robot{
            color:#6366f1;   /* AI purple */
        }

        .card-title .fa-file-pdf{
            color:#ef4444;   /* PDF red */
        }


        /* ---------- PDF LIST ---------- */
        .pdf-select-row{
            background:#ffffff;
            border:1px solid #e5e7eb;
            border-radius:10px;
            padding:12px 14px;
            transition:all .25s ease;
        }

        .pdf-select-row:hover{
            background:#f8fafc;
            border-color:#1EAE98;
        }

        /* checkbox spacing */
        .pdf-select-row input{
            accent-color:#1EAE98;
            transform:scale(1.1);
        }


        /* ---------- CONFIGURATION AREA ---------- */
        .assessment-config-grid{
            display:grid;
            gap:18px;
        }

        /* FIX SELECT LOOK */
        .assessment-select{
            width:160px;
            padding:8px 10px;

            border:1px solid #d1d5db;
            border-radius:8px;

            background:#fff;
            font-size:14px;

            transition:.2s;
        }

        .assessment-select:focus{
            outline:none;
            border-color:#1EAE98;
            box-shadow:0 0 0 2px #e6f8f7;
        }


        /* textarea polish */
        .assessment-textarea{
            border:1px solid #d1d5db;
            border-radius:10px;
            padding:12px;
            resize:none;
        }

        .assessment-textarea:focus{
            outline:none;
            border-color:#1EAE98;
        }


        /* ---------- GENERATE BUTTON ---------- */
        .generate-card{
            background:#f8fafc;
            border:1px dashed #cbd5e1;
        }

        .generate-btn{
            background:linear-gradient(
                135deg,
                var(--brand),
                #178d79
            );

            border:none;
            color:white;

            padding:14px 30px;
            font-size:15px;
            font-weight:600;

            border-radius:10px;

            display:inline-flex;
            align-items:center;
            gap:8px;

            transition:all .25s ease;
        }

        .generate-btn:hover{
            transform:translateY(-2px);
            box-shadow:0 8px 20px rgba(30,174,152,.35);
        }

        .generate-btn i{
            opacity:0.9;
        }

        /* ===== PDF SELECT ===== */

        .pdf-list{
            display:flex;
            flex-direction:column;
            gap:10px;
        }

        .pdf-select-row{
            display:flex;
            justify-content:space-between;
            align-items:center;

            padding:14px 16px;
            border:1px solid #e5e7eb;
            border-radius:10px;

            cursor:pointer;
            transition:all .25s ease;
            background:#fff;
        }

        .pdf-select-row:hover{
            border-color:#1EAE98;
            background:#f8fafc;
        }

        /* LEFT SIDE */
        .pdf-left{
            display:flex;
            align-items:center;
            gap:12px;
        }

        .pdf-icon{
            color:#ef4444;
            font-size:18px;
        }

        /* RIGHT CHECK */
        .selected-icon{
            color:#1EAE98;
            font-size:18px;
            opacity:0;
            transition:.2s;
        }

        /* SELECTED STATE */
        .pdf-select-row.selected{
            border-color:#1EAE98;
            background:#ecfdf5;
        }

        .pdf-select-row.selected .selected-icon{
            opacity:1;
        }

        .pdf-label{
            display:flex;
            align-items:center;
            gap:12px;
            width:100%;
            cursor:pointer;
        }

        .file-checkbox{
            accent-color:#1EAE98;
            transform:scale(1.1);
        }

        .assessment-alert{
            display:flex;
            align-items:center;
            gap:10px;

            padding:14px 16px;
            margin-bottom:15px;

            border-radius:10px;
            font-size:14px;
        }

        /* ERROR */
        .assessment-alert.error{
            background:#fef2f2;
            border:1px solid #fecaca;
            color:#991b1b;
        }

        /* SUCCESS */
        .assessment-alert.success{
            background:#ecfdf5;
            border:1px solid #bbf7d0;
            color:#065f46;
        }

        .ai-feedback{
            animation: fadeInAI .25s ease;
        }

        @keyframes fadeInAI{
            from{
                opacity:0;
                transform:translateY(6px);
            }
            to{
                opacity:1;
                transform:translateY(0);
            }
        }

        .ai-feedback li{
            background:#ffffff;
            border:1px solid #e5e7eb;
            padding:10px 12px;
            border-radius:8px;
        }
    </style>
</head>
<script>
    window.addEventListener("pageshow", function (event) {

        // true when page restored from back/forward cache
        if (event.persisted ||
            performance.getEntriesByType("navigation")[0]?.type === "back_forward") {

            window.location.reload();
        }

    });
</script>
<body>
<section class="dashboard-layout">

    <main class="main-content">


        <header class="main-header">
            <a href="{% url 'contributor_submit_content_view' %}?course_id={{ course.id }}&chapter_id={{ chapter.id }}"
               class="back-link">
                <i class="fas fa-arrow-left"></i> Back to Topics
            </a>
            <!--            <h2 style="text-align: center;">Upload Content</h2>-->
        </header>

        <div class="tabs">
            <a href="?course_id={{ course.id }}&chapter_id={{ chapter.id }}&topic={{ topic }}&tab=content"
               class="tab {% if tab == 'content' %}active{% endif %}">
                Content
            </a>

            <a href="?course_id={{ course.id }}&chapter_id={{ chapter.id }}&topic={{ topic }}&tab=assessments"
               class="tab {% if tab == 'assessments' %}active{% endif %}">
                Assessments
            </a>
        </div>

        <div class="submission-banner">
            <i class="fas fa-info-circle"></i>

            <span>
                After completing content or uploads,
                return to
                <a href="{% url 'contributor_submit_content_view' %}?course_id={{ course.id }}&chapter_id={{ chapter.id }}"
                   class="topics-link">
                    <b>Topics</b>
                </a>
                to confirm your submission.
            </span>
        </div>

        <!-- ===== Submission Context (Breadcrumb Style) ===== -->
        <div class="submission-context submission-warning">
            <span class="context-label">Context</span>

            <div class="context-path">

                <!-- SUBJECT -->
                <a href="{% url 'contributor_dashboard' %}"
                   class="context-item link-item">
                    <i class="fas fa-book"></i>
                    {{ course.course_name }} ({{ course.course_code }})
                </a>

                <i class="fas fa-chevron-right separator"></i>

                <!-- CHAPTER -->
                <a href="{% url 'contributor_submit_content_view' %}?course_id={{ course.id }}&chapter_id={{ chapter.id }}"
                   class="context-item link-item">
                    Chapter {{ chapter.chapter_number }}: {{ chapter.chapter_name }}
                </a>

                <i class="fas fa-chevron-right separator"></i>

                <!-- TOPIC (current, not clickable) -->
                <span class="context-item topic">
            {{ topic }}
        </span>

            </div>

        </div>

        {% if tab == "content" %}
        <div class="content-layout">

            <!-- ===== LEFT: PRIMARY WORK AREA ===== -->
            <div class="primary-column">

                <section class="guidelines-card" style="margin-bottom:18px;">
                    <!-- HEADER ROW -->
                    <div class="guidelines-header">

                        <!-- Toggle -->
                        <button type="button"
                                class="guidelines-toggle"
                                id="guidelinesToggle">

                            <div class="guidelines-title">
                                <i class="fas fa-lightbulb"></i>
                                Content Guidelines
                            </div>

                            <i class="fas fa-chevron-down arrow"
                               id="guidelinesArrow"></i>
                        </button>

                        <button id="aiTopicCheckBtn" class="ai-chip">
                            <i class="fas fa-robot"></i>
                            AI Review
                        </button>

                    </div>

                    <div class="guidelines-body" id="guidelinesBody">
                        <div class="guideline-list">

                            <div class="guideline-item">
                                <i class="fas fa-check-circle"></i>
                                Keep the language simple and easy for students.
                            </div>

                            <div class="guideline-item">
                                <i class="fas fa-check-circle"></i>
                                Include examples to explain the concept clearly.
                            </div>

                            <div class="guideline-item">
                                <i class="fas fa-check-circle"></i>
                                Cover all sub-topics as per syllabus.
                            </div>

                            <div class="guideline-item">
                                <i class="fas fa-check-circle"></i>
                                Maintain a clear flow: headings â†’ explanation â†’ example.
                            </div>

                            <div class="guideline-item">
                                <i class="fas fa-check-circle"></i>
                                Add scenario-based explanation or real-world use case if possible.
                            </div>

                            <div class="guideline-item">
                                <i class="fas fa-check-circle"></i>
                                Upload supporting files if needed (PDF / PPT / Video).
                            </div>

                            <div class="guideline-item">
                                <i class="fas fa-check-circle"></i>
                                Generate assessment after uploading PDF notes (optional but recommended).
                            </div>

                        </div>

                        <div class="guideline-note">
                            âœ… Your content will be evaluated on: relevance, completeness, clarity, coherence, and engagement.
                        </div>
                    </div>

                    <div id="topicAiFeedback" class="ai-feedback"></div>
                </section>

                <section class="card editor-card">
                    <h2 class="card-title">Content Editor</h2>
                    <form id="editorForm" method="POST" action="{% url 'contributor_editor' %}">
                        {% csrf_token %}
                        <input type="hidden" name="file_id" id="file_id">
                        <input type="hidden" name="course_id" value="{{ course.id }}">
                        <input type="hidden" name="chapter_id" value="{{ chapter.id }}">
                        <input type="hidden" name="topic" value="{{ topic }}">
                        <div style="margin-bottom: 15px;">
                            <label for="filename" class="filename-label">Filename:</label>
                            <input type="text" name="filename" id="filename"
                                   placeholder="Enter file name (e.g., Intro_TopicA)"
                                   required class="filename-input">
                        </div>
                        <textarea id="editor" name="notes" placeholder="  Start writing your notes here..."></textarea>
                        <div class="editor-actions">
                            <button class="btn btn-secondary important" type="submit" name="action" value="draft">Save
                                Draft
                            </button>
                            <button class="btn btn-gradient " type="submit" name="action" value="submitDraft">Submit as
                                PDF
                            </button>
                        </div>
                    </form>
                </section>
            </div>

            <!-- ===== RIGHT: SUPPORTING AREA ===== -->
            <div class="secondary-column">

                <section class="card editor-card">
                    <h2 class="card-title">External Resources</h2>

                    <form id="resourceForm">
                        {% csrf_token %}
                        <input type="hidden" name="course_id" value="{{ course.id }}">
                        <input type="hidden" name="chapter_id" value="{{ chapter.id }}">
                        <input type="hidden" name="topic" value="{{ topic }}">

                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <input type="text" id="resTitle" placeholder="Resource title (e.g., DNS Explained)"
                                   style="padding:10px; border:1px solid #d1d5db; border-radius:8px;" required>

                            <input type="url" id="resUrl" placeholder="Paste link (YouTube / Website)"
                                   style="padding:10px; border:1px solid #d1d5db; border-radius:8px;" required>

                            <select id="resType"
                                    style="padding:10px; border:1px solid #d1d5db; border-radius:8px;">
                                <option value="youtube">YouTube</option>
                                <option value="article">Article</option>
                                <option value="docs">Docs/Notes</option>
                                <option value="other">Other</option>
                            </select>

                            <button type="submit" class="btn btn-gradient  btn-sm">
                                + Add Resource
                            </button>
                        </div>
                    </form>

                    <div style="margin-top:15px;">
                        <h3 style="margin-bottom:10px;">Added Links</h3>
                        <ul id="resourceList" style="display:flex; flex-direction:column; gap:10px;"></ul>
                    </div>
                </section>


                <!-- File list -->
                <section class="card editor-card">
                    <h2 class="card-title">Your Existing Files</h2>

<!--                    <form id="assessmentForm" method="POST" action="{% url 'generate_assessment' %}">-->
<!--                        {% csrf_token %}-->
                        <div class="files-scroll-container">
                            <input type="hidden" name="course_id" value="{{ course.id }}">
                            <input type="hidden" name="chapter_id" value="{{ chapter.id }}">
                            <input type="hidden" name="topic" value="{{ topic }}">

                            <!-- ================= PDFs ================= -->
                            <h3 style="margin-bottom:10px;">PDFs</h3>
                            <ul class="file-group">
                                {% for file in files %}
                                {% if file.type == 'pdf' %}
                                <li style="display:flex; align-items:center; gap:10px;">
<!--                                    <input-->
<!--                                            type="checkbox"-->
<!--                                            name="selected_files"-->
<!--                                            value="{{ file.id }}"-->
<!--                                            class="file-checkbox"-->
<!--                                            placeholder="Nothing to show yet"-->
<!--                                    >-->
                                    <a href="https://drive.google.com/uc?export=download&id={{ file.id }}"
                                       target="_blank">
                                        {{ file.name }}
                                    </a>
                                    <button type="button"
                                            class="delete-icon-btn"
                                            title="Delete file"
                                            data-fileid="{{ file.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </li>
                                {% endif %}
                                {% empty %}
                                <li>No PDFs uploaded yet.</li>
                                {% endfor %}
                            </ul>

                            <!-- ================= Drafts ================= -->
                            <h3 style="margin-top:20px; margin-bottom:10px;">Drafts</h3>
                            <ul class="file-group">
                                {% for file in files %}
                                {% if file.type == 'drafts' %}
                                <li style="display:flex; align-items:center; gap:10px;">
                                    <a href="#"
                                       class="load-file"
                                       data-fileid="{{ file.id }}">
                                        {{ file.name }}
                                    </a>
                                    <button type="button"
                                            class="delete-icon-btn"
                                            title="Delete file"
                                            data-fileid="{{ file.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </li>
                                {% endif %}
                                {% endfor %}
                            </ul>

                            <!-- ================= Videos ================= -->
                            <h3 style="margin-top:20px; margin-bottom:10px;">Videos</h3>
                            <ul class="file-group">
                                {% for file in files %}
                                {% if file.type == 'videos' %}
                                <li style="display:flex; align-items:center; gap:10px;">
                                    <a href="https://drive.google.com/uc?export=download&id={{ file.id }}"
                                       target="_blank">
                                        {{ file.name }}
                                    </a>
                                    <button type="button"
                                            class="delete-icon-btn"
                                            title="Delete file"
                                            data-fileid="{{ file.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </li>
                                {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
<!--                        &lt;!&ndash; ================= Generate Button ================= &ndash;&gt;-->
<!--                        {% if has_pdfs %}-->
<!--                        <div id="selectionInfo"-->
<!--                             style="font-size:13px; color:#6b7280; margin-top:10px;">-->
<!--                            No PDFs selected-->
<!--                        </div>-->

<!--&lt;!&ndash;                        <div class="submit-button-container"&ndash;&gt;-->
<!--&lt;!&ndash;                             style="margin-top:12px; display:flex; justify-content:flex-end;">&ndash;&gt;-->
<!--&lt;!&ndash;                            <button type="submit"&ndash;&gt;-->
<!--&lt;!&ndash;                                    class="btn btn-gradient  btn-sm"&ndash;&gt;-->
<!--&lt;!&ndash;                                    onclick="return validateAssessmentSelection();">&ndash;&gt;-->
<!--&lt;!&ndash;                                Generate Assessment&ndash;&gt;-->
<!--&lt;!&ndash;                            </button>&ndash;&gt;-->
<!--&lt;!&ndash;                        </div>&ndash;&gt;-->
<!--                        {% else %}-->
<!--                        <div style="margin-top:25px; padding:15px; background:#f8fafc; border:1px dashed #cbd5e1; border-radius:8px;-->
<!--                    color:#475569;-->
<!--                    font-size:14px;-->
<!--                    text-align:center;">-->
<!--                            ðŸ“„ Upload PDF notes to generate an assessment.-->
<!--                        </div>-->
<!--                        {% endif %}-->

<!--                    </form>-->
                </section>

                <section class="card upload-card upload-section">
                    <h2 class="card-title">Upload Supporting Files</h2>

                    <form id="uploadForm" method="POST" enctype="multipart/form-data" action="{% url 'upload_files' %}">
                        {% csrf_token %}
                        <input type="hidden" name="course_id" value="{{ course.id }}">
                        <input type="hidden" name="chapter_id" value="{{ chapter.id }}">
                        <input type="hidden" name="topic" value="{{ topic }}">

                        <!--                    <label>Upload Supporting Files</label>-->

                        <div class="file-drop-zone" id="file-drop-zone">
                            <input type="file"
                                   id="supporting-upload"
                                   name="supporting_files"
                                   accept=".pdf,.doc,.docx,video/*"
                                   multiple>

                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop PDFs, Docs, or Videos</p>
                            <label for="supporting-upload" class="browse-btn">
                                Browse files
                            </label>
                        </div>

                        <div id="upload-file-list"></div>

                        <div class="submit-button-container">
                            <button class="btn btn-secondary important" type="submit" value="submit" name="action">
                                Upload Selected Files
                            </button>
                        </div>
                    </form>
                </section>
            </div>
            {% endif %}

            {% if tab == "assessments" %}

            <div class="assessment-layout">

                <!-- ================= LEFT WORKSPACE ================= -->
                <div class="assessment-primary">

                    <form id="generateAssessmentForm" method="POST" action="{% url 'generate_assessment' %}">
                        {% csrf_token %}

                        <input type="hidden" name="course_id" value="{{ course.id }}">
                        <input type="hidden" name="chapter_id" value="{{ chapter.id }}">
                        <input type="hidden" name="topic" value="{{ topic }}">


                        <!-- ===== SELECT PDFs ===== -->
                        <section class="card">
                            <h2 class="card-title">
                                <i class="fas fa-file-pdf"></i>
                                Select Source Material
                            </h2>

                            <!-- ================= PDFs ================= -->
                            <h3 style="margin-bottom:10px;">PDFs</h3>
                            <ul class="pdf-list">

                                {% for file in files %}
                                {% if file.type == 'pdf' %}

                                <li class="pdf-select-row">

                                    <label class="pdf-label">

                                        <input
                                                type="checkbox"
                                                name="selected_files"
                                                value="{{ file.id }}"
                                                class="file-checkbox"
                                        >

                                        <div class="pdf-left">
                                            <i class="fas fa-file-pdf pdf-icon"></i>
                                            <span>{{ file.name }}</span>
                                        </div>

                                    </label>

                                </li>

                                {% endif %}
                                {% endfor %}

                            </ul>

                <!--                        &lt;!&ndash; ================= Generate Button ================= &ndash;&gt;-->
                <!--                        {% if has_pdfs %}-->
                <!--                        <div id="selectionInfo"-->
                <!--                             style="font-size:13px; color:#6b7280; margin-top:10px;">-->
                <!--                            No PDFs selected-->
                <!--                        </div>-->

                <!--&lt;!&ndash;                        <div class="submit-button-container"&ndash;&gt;-->
                <!--&lt;!&ndash;                             style="margin-top:12px; display:flex; justify-content:flex-end;">&ndash;&gt;-->
                <!--&lt;!&ndash;                            <button type="submit"&ndash;&gt;-->
                <!--&lt;!&ndash;                                    class="btn btn-primary btn-sm"&ndash;&gt;-->
                <!--&lt;!&ndash;                                    onclick="return validateAssessmentSelection();">&ndash;&gt;-->
                <!--&lt;!&ndash;                                Generate Assessment&ndash;&gt;-->
                <!--&lt;!&ndash;                            </button>&ndash;&gt;-->
                <!--&lt;!&ndash;                        </div>&ndash;&gt;-->
                <!--                        {% else %}-->
                                        <div style="margin-top:25px; padding:15px; background:#f8fafc; border:1px dashed #cbd5e1; border-radius:8px;
                                    color:#475569;
                                    font-size:14px;
                                    text-align:center;">
                                            ðŸ“„ Upload PDF notes to generate an assessment.
                                        </div>
                                        {% endif %}
                        </section>


                        <!-- ===== AI SETTINGS ===== -->
                        <section class="card">
                            <h2 class="card-title">
                                <i class="fas fa-robot"></i>
                                Assessment Configuration
                            </h2>

                            <div class="assessment-config-grid">

                                <textarea name="custom_prompt"
                                          class="assessment-textarea"
                                          placeholder="Optional instruction"></textarea>

                                <div style="display:flex;gap:20px;align-items:center;">

                                    <div>
                                        <label><strong>Difficulty</strong></label><br>
                                        <select name="difficulty" class="assessment-select">
                                            <option>Easy</option>
                                            <option selected>Medium</option>
                                            <option>Hard</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label><strong>No. of Questions</strong></label><br>
                                        <select name="question_count" class="assessment-select">
                                            <option>5</option>
                                            <option selected>10</option>
                                            <option>15</option>
                                            <option>20</option>
                                        </select>
                                    </div>

                                </div>

                            </div>
                        </section>


                        <!-- ===== GENERATE ===== -->
                        <section class="card generate-card" style="text-align:right;">
                            {% if messages %}
                            <div style="margin-bottom:20px;">
                                {% for message in messages %}

                                <div class="assessment-alert {{ message.tags }}">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    {{ message }}
                                </div>

                                {% endfor %}
                            </div>
                            {% endif %}
                            <button class="generate-btn">
                                <i class="fas fa-bolt"></i>
                                Generate Assessment
                            </button>
                        </section>

                    </form>

                </div>


                <!-- ================= RIGHT PANEL ================= -->
                <div class="assessment-secondary">

                    <section class="card">

                        <h2 class="card-title">
                            Generated Assessments
                        </h2>

                        {% if assessments %}
                        <div style="display:flex;flex-direction:column;gap:12px;">

                            {% for a in assessments %}
                            <div class="assessment-item">

                                <div>
                                    <strong>Assessment #{{ a.id }}</strong>
                                    <div class="assessment-meta">
                                        {{ a.created_at|date:"M d, Y" }}
                                    </div>
                                </div>

                                <a href="{% url 'generated_assessment_form' a.id %}"
                                   class="btn btn-secondary btn-sm">
                                    Open
                                </a>

                            </div>
                            {% endfor %}

                        </div>

                        {% else %}
                        <div class="empty-state">
                            No assessments generated yet.
                        </div>
                        {% endif %}

                    </section>

                </div>

            </div>

            {% endif %}
        </div>
    </main>
</section>

<button id="chat-toggle-btn" class="chatbot-btn"><i class="fas fa-comments"></i></button>
<div id="chat-panel" class="chat-panel">
    <div class="chat-header"><h3>Chat Assistant</h3>
        <button id="chat-close-btn" class="chat-close-btn">&times;</button>
    </div>
    <div class="chat-messages" id="chat-messages">
        <div class="message bot">Hello! How can I assist you?</div>
    </div>
    <div class="chat-input-area">
        <input type="file" id="chat-file" multiple style="display:none" />

        <button type="button" id="chat-attach-btn"
                style="background:#eef1f1; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer;">
            <i class="fas fa-paperclip"></i>
        </button>

        <input type="text" id="chat-input" placeholder="Type your message...">

        <button id="chat-send-btn"><i class="fas fa-paper-plane"></i></button>
    </div>

</div>
<div id="chat-overlay" class="overlay"></div>

<div id="loadingOverlay"
     style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 9999;">
    <span id="loadingText"
          style="padding: 15px 25px; background: #1EAE98; color: white; border-radius: 8px; font-weight: bold;">Loading... â³</span>
</div>


<script>
    const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB

    document.addEventListener('DOMContentLoaded', function() {
        const body = document.body;

        // --- TinyMCE Initialization ---
        tinymce.init({
             selector: '#editor', height: 600, menubar: 'file edit view insert format tools table help',
             plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount',
             toolbar: 'undo redo | styles | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | forecolor backcolor | table image link media | removeformat | fullscreen',
             toolbar_mode: 'wrap',
             content_style: 'body { font-family:Arial,Helvetica,sans-serif; font-size:14px; line-height:1.6; color:#333; }',
             branding: false,
             resize: false
        });

        // --- Loading Overlay Functions ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');

        // --- Editor Form Submission (Traditional POST) ---
        const editorForm = document.getElementById('editorForm');
        if (editorForm) {
            editorForm.addEventListener('submit', function(e) {
                const editor = tinymce.get('editor');
                if (editor) { editor.save(); } // Sync content
                // Form will now submit normally and redirect
            });
        }

        // --- File Upload UI Logic (Still active) ---
        const fileInput = document.getElementById('supporting-upload');
        const dropZone = document.getElementById('file-drop-zone');
        const fileList = document.getElementById('upload-file-list');

        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
          dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('dragover');
          fileInput.files = e.dataTransfer.files;
          renderFileList(fileInput.files);
        });

        fileInput.addEventListener('change', () => {
          renderFileList(fileInput.files);
        });

        function renderFileList(files) {
          fileList.innerHTML = '';

          Array.from(files).forEach(file => {
            const div = document.createElement('div');
            div.className = 'file-item';

            if(file.size > MAX_FILE_SIZE){
                alert(`${file.name} exceeds 20MB limit`);
                fileInput.value = "";
                return;
            }

            div.innerHTML = `
              <span class="file-details">
                <i class="fas fa-file file-icon"></i>
                ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)
              </span>
            `;

            fileList.appendChild(div);
          });
        }

        // --- Chat Panel Logic ---
        const chatToggleBtn = document.getElementById('chat-toggle-btn');
        const chatPanel = document.getElementById('chat-panel');
        const chatCloseBtn = document.getElementById('chat-close-btn');
        const chatOverlay = document.getElementById('chat-overlay');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');

        function openChat() { body.classList.add('chat-open'); }
        function closeChat() { body.classList.remove('chat-open'); }
        if (chatToggleBtn) chatToggleBtn.addEventListener('click', openChat);
        if (chatCloseBtn) chatCloseBtn.addEventListener('click', closeChat);
        if (chatOverlay) chatOverlay.addEventListener('click', closeChat);

        function addChatMessage(message, sender = 'bot') {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            messageDiv.innerHTML = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        const chatFileInput = document.getElementById("chat-file");
        const chatAttachBtn = document.getElementById("chat-attach-btn");

        if (chatAttachBtn) {
          chatAttachBtn.addEventListener("click", () => {
            chatFileInput.click();
          });
        }

        async function handleChatSend() {
          const userMessage = chatInput.value.trim();
          const files = chatFileInput.files;

          if (!userMessage && (!files || files.length === 0)) return;

          // Show user message
          if (userMessage) addChatMessage(userMessage, "user");

          // Show file names
          if (files && files.length > 0) {
            let fileNames = Array.from(files).map(f => `ðŸ“Ž ${f.name}`).join("<br>");
            addChatMessage(fileNames, "user");
          }

          try {
            const formData = new FormData();
            formData.append("message", userMessage);

            if (files && files.length > 0) {
              Array.from(files).forEach(file => formData.append("files", file));
            }

            const res = await fetch("{% url 'gemini_chat' %}", {
              method: "POST",
              headers: {
                "X-CSRFToken": "{{ csrf_token }}"
              },
              body: formData
            });

            const data = await res.json();

            if (data.reply) addChatMessage(data.reply, "bot");
            else if (data.error) addChatMessage(`Error: ${data.error}`, "bot");

            chatInput.value = "";
            chatFileInput.value = "";

          } catch (err) {
            addChatMessage(`Error: ${err.message}`, "bot");
          }
        }

        if (chatSendBtn) chatSendBtn.addEventListener('click', handleChatSend);
        if (chatInput) chatInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { handleChatSend(); } });


        // âœ… Guidelines toggle
        const guidelinesToggle = document.getElementById("guidelinesToggle");
        const guidelinesBody = document.getElementById("guidelinesBody");
        const guidelinesArrow = document.getElementById("guidelinesArrow");

        if (guidelinesToggle && guidelinesBody && guidelinesArrow) {
          guidelinesToggle.addEventListener("click", () => {
            guidelinesBody.classList.toggle("show");

            if (guidelinesBody.classList.contains("show")) {
              guidelinesArrow.style.transform = "rotate(180deg)";
            } else {
              guidelinesArrow.style.transform = "rotate(0deg)";
            }
          });
        }

        const resourceForm = document.getElementById("resourceForm");
        const resourceList = document.getElementById("resourceList");

        async function loadResources() {
          const courseId = "{{ course.id }}";
          const chapterId = "{{ chapter.id }}";
          const topic = "{{ topic }}";

          const res = await fetch(`{% url 'list_resources' %}?course_id=${courseId}&chapter_id=${chapterId}&topic=${encodeURIComponent(topic)}`);
          const data = await res.json();

          resourceList.innerHTML = "";

          (data.resources || []).forEach(r => {
            const li = document.createElement("li");
            li.style.display = "flex";
            li.style.justifyContent = "space-between";
            li.style.alignItems = "center";
            li.style.padding = "10px";
            li.style.border = "1px solid #e5e7eb";
            li.style.borderRadius = "8px";

            li.innerHTML = `
              <div>
                <a href="${r.url}" target="_blank" style="font-weight:600; color:#111827;">
                  ${r.title}
                </a>
                <div style="font-size:12px; color:#6b7280;">${r.type.toUpperCase()}</div>
              </div>
              <button class="delete-icon-btn" data-id="${r.id}">
                <i class="fas fa-trash"></i>
              </button>
            `;

            resourceList.appendChild(li);
          });

          document.querySelectorAll("#resourceList .delete-icon-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
              const id = btn.dataset.id;

              await fetch("{% url 'delete_resource' %}", {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                body: new URLSearchParams({ id })
              });

              loadResources();
            });
          });
        }

        if (resourceForm) {
          resourceForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const title = document.getElementById("resTitle").value.trim();
            const url = document.getElementById("resUrl").value.trim();
            const type = document.getElementById("resType").value;

            const formData = new FormData();
            formData.append("course_id", "{{ course.id }}");
            formData.append("chapter_id", "{{ chapter.id }}");
            formData.append("topic", "{{ topic }}");
            formData.append("title", title);
            formData.append("url", url);
            formData.append("type", type);

            await fetch("{% url 'add_resource' %}", {
              method: "POST",
              headers: { "X-CSRFToken": "{{ csrf_token }}" },
              body: formData
            });

            document.getElementById("resTitle").value = "";
            document.getElementById("resUrl").value = "";
            document.getElementById("resType").value = "youtube";

            loadResources();
          });
        }

        loadResources();


        document.querySelectorAll(".file-checkbox")
            .forEach(cb => {

                cb.addEventListener("change", function(){

                    const row = this.closest(".pdf-select-row");

                    if(this.checked)
                        row.classList.add("selected");
                    else
                        row.classList.remove("selected");
                });

            });

    }); // End DOMContentLoaded

    document.querySelectorAll('.load-file').forEach(link => {
    link.addEventListener('click', async function(e) {
        e.preventDefault();
        const fileId = this.dataset.fileid;

        try {
            const res = await fetch(`{% url 'load_file' %}?file_id=${fileId}`);
            if (!res.ok) throw new Error("Failed to load file");
            const data = await res.json();

            // Ensure TinyMCE is ready
            const editor = tinymce.get('editor');
            if (editor) {
                editor.setContent(data.content || '');
                document.getElementById('file_id').value = fileId;
            } else {
                console.warn("TinyMCE editor not initialized yet");
            }

            // Set filename input (remove extensions)
            const cleanName = this.textContent.replace(/\.(docx|pdf)$/i, '');
            document.getElementById('filename').value = cleanName;

        } catch(err) {
            alert("Error loading file: " + err.message);
        }
    });
    });

    const checkboxes = document.querySelectorAll('.file-checkbox');
    const info = document.getElementById('selectionInfo');

    checkboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        const count = document.querySelectorAll('.file-checkbox:checked').length;
        info.textContent = count > 0
          ? `${count} PDF${count > 1 ? 's' : ''} selected`
          : 'No PDFs selected';
      });
    });


    function validateAssessmentSelection() {
        const selected = document.querySelectorAll(
            'input.file-checkbox:checked'
        );

        if (selected.length === 0) {
            alert("Please select at least one PDF to generate assessment.");
            return false;
        }

        return true;
    }


    document.querySelectorAll('.delete-icon-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const fileId = this.dataset.fileid;
        if (!confirm("Are you sure you want to delete this file?")) return;

        try {
            const res = await fetch("{% url 'delete_drive_file' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `file_id=${fileId}`
            });
            const data = await res.json();
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert("Error: " + data.message);
            }
        } catch (err) {
            alert("Error deleting file: " + err.message);
        }

    });

});

</script>

<script>
    const topicCheckBtn = document.getElementById("aiTopicCheckBtn");
const topicFeedback = document.getElementById("topicAiFeedback");

if (topicCheckBtn) {

    topicCheckBtn.addEventListener("click", async () => {

        topicFeedback.style.display = "block";
        topicFeedback.innerHTML =
            "ðŸ¤– Evaluating topic content...";

        const editor = tinymce.get("editor");
        const notes = editor ? editor.getContent() : "";

        const files = Array.from(
            document.querySelectorAll(".file-group a")
        ).map(a => a.textContent.trim());

        try {

            const res = await fetch(
                "{% url 'check_topic_quality' %}",
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({
                        topic: "{{ topic }}",
                        notes: notes,
                        files: files
                    })
                }
            );

            const data = await res.json();

            const suggestions = data.suggestions || [];

            topicFeedback.innerHTML = `
            <strong>ðŸ¤– AI Suggestions</strong>
            ${
            suggestions.length
            ? `<div>
            ${suggestions.map(s => {

                // âœ… HANDLE STRING suggestions
                if (typeof s === "string") {
                    return `
                    <div class="ai-suggestion">
                        âš  Writing suggestion
                        <br>âœ… ${s}
                    </div>`;
                }

                // âœ… HANDLE OBJECT suggestions safely
                const issue = s.issue || "Writing improvement";
                const fix = s.fix || "";
                const example = s.example || "";

                return `
                <div class="ai-suggestion">
                    âš  ${issue}
                    ${fix ? `<br>âœ… ${fix}` : ""}
                    ${example ? `<br>âœ ${example}` : ""}
                </div>`;
            }).join("")}
            </div>`
            : `<p>âœ… Your content looks clear and well structured.</p>`
            }
            `;

        } catch (e) {
            topicFeedback.innerHTML =
                "âŒ AI evaluation failed.";
        }

    });
}
</script>
<script>

    function showAssessmentMessage(message, type="error") {

    const container =
        document.querySelector(".generate-card");

    const old =
        container.querySelector(".dynamic-alert");

    if(old) old.remove();

    const div = document.createElement("div");
    div.className =
        `assessment-alert ${type} dynamic-alert`;

    div.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        ${message}
    `;

    container.prepend(div);
}
    document
    .getElementById("generateAssessmentForm")
    .addEventListener("submit", async function(e){

        e.preventDefault(); // âœ… STOP PAGE REDIRECT

        const form = this;
        const formData = new FormData(form);

        try {

            const response = await fetch(form.action,{
                method:"POST",
                headers:{
                    "X-CSRFToken":"{{ csrf_token }}"
                },
                body:formData
            });

            const data = await response.json();

            // âœ… ERROR CASE
            if(!response.ok){
                showAssessmentMessage(
                    data.error || "Something went wrong"
                );
                return;
            }

            // âœ… SUCCESS CASE
            if(data.redirect_url){
                window.location.href = data.redirect_url;
            }

        }
        catch(err){
            console.error(err);
        }

    });
</script>
</body>
</html>