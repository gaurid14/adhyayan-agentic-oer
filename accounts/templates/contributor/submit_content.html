{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter Content</title>
    <link rel="stylesheet" href="{% static 'accounts/sidebar.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Reset & Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #FFFFFF; color: #333;  min-height: 100vh; }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }

        /* --- MODIFIED MAIN CONTENT AREA --- */
        .main-content {
            margin-left: 260px;
            /* MODIFIED: Better padding for a full-width look */
            padding: 40px 60px;
            min-height: 100vh;
            /* REMOVED max-width and margin: 0 auto to use full page */
        }
        /* --- END OF MODIFICATION --- */

        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }

        /* MODIFIED: Made title bigger and bolder */
        .main-header h1 {
            font-size: 2.25rem; /* ~36px */
            font-weight: 700;
            color: #222;
        }

        /* Cards */
        .card {
            background-color: #ffffff; border-radius: 10px; padding: 22px 26px;
            margin-bottom: 30px;
            border: 1px solid #E5E7EB;
            /* MODIFIED: A slightly softer, more modern shadow */
            box-shadow: none;
            opacity: 0; transform: translateY(20px); animation: fadeInCard 0.5s ease-out forwards;
        }
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 14px;
            padding-bottom: 8px;
            border-bottom: 1px solid #E5E7EB;
        }


        /* --- SUBMISSION DETAILS STYLES --- */
        .submission-info p { font-size: 16px; margin-bottom: 8px; color: #555; }
        .submission-info strong { color: #111827; font-weight: 600; }

        /* --- TOPICS TABLE STYLES --- */
        .topics-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .topics-table th, .topics-table td { padding: 15px 12px; text-align: left; border-bottom: 1px solid #eee; }
        .topics-table th {
            font-weight: 600; color: #555; font-size: 14px; text-transform: uppercase; background-color: #FAFAFA;
        }
        .topics-table td { font-size: 15px; color: #333; vertical-align: middle; }

        .topics-table th.action-column,
        .topics-table td.action-column {
            text-align: center;
            width: 150px;
        }

        /* General Button Styles for Table Actions */
        .action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 7px 15px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent; /* Added for outline button */
            transition: all 0.2s ease; /* Broadened transition */
            text-decoration: none;
            color: white;
        }
        .action-button i { margin-right: 6px; }
        .action-button:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.15); }

        /* Specific styles for Upload button */
        .upload-button { background-color: #1EAE98; border-color: #1EAE98; }
        .upload-button:hover { background-color: #178D79; border-color: #178D79; }

        /* --- MODIFIED: "View" button is now an outline button --- */
        .view-past-button {
            background-color: #fff;
            color: #6c757d;
            border-color: #6c757d;
        }
        .view-past-button:hover {
            background-color: #6c757d;
            color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        /* --- END OF MODIFICATION --- */

        /* Table Row Hover Animation */
        .topics-table tbody tr { transition: background-color 0.2s ease; }
        .topics-table tbody tr:hover { background-color: #e6f8f7; }

        /* --- ANIMATIONS --- */
        @keyframes fadeInCard { to { opacity: 1; transform: translateY(0); } }
        .submission-info { animation-delay: 0.1s; }
        .topics-card { animation-delay: 0.2s; }

        /* --- FINAL SUBMISSION BUTTON STYLES --- */
        .final-submission-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #eee; /* Separator line */
            text-align: center;
            opacity: 0; transform: translateY(20px); animation: fadeInCard 0.5s ease-out 0.3s forwards;
        }

        /* ADDED: Hides the messy <hr> tag */
        .final-submission-section hr {
            display: none;
        }

        .final-submission-section p {
            margin-bottom: 20px;
            color: #555;
            font-size: 15px;
        }
        .final-submit-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 30px;
            border: none;
            border-radius: 25px; /* Rounded pill shape */
            background-color: #1EAE98;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
        }
         .final-submit-button i {
            margin-right: 8px;
         }
        .final-submit-button:hover {
            background-color:#178D79;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
        }

        /* --- MODAL STYLES START --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            width: 700px;
            max-width: 90%;
            z-index: 1001;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            opacity: 1;
            transform: scale(1);
        }
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            font-size: 18px;
            color: #333;
        }
        .modal-close-btn {
            font-size: 24px;
            font-weight: bold;
            color: #888;
            cursor: pointer;
            background: none;
            border: none;
        }
        .modal-close-btn:hover {
            color: #000;
        }
        .modal-body {
            padding: 25px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .file-table {
            width: 100%;
            border-collapse: collapse;
        }
        .file-table th, .file-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            text-align: left;
        }
        .file-table th {
            font-size: 13px;
            color: #555;
            text-transform: uppercase;
        }
        .file-table td {
            font-size: 15px;
        }
        .file-table .file-icon {
            font-size: 18px;
            margin-right: 10px;
            color: #6c757d;
        }
        .file-table .fa-file-pdf { color: #e74c3c; }
        .file-table .fa-file-word { color: #2a5699; }
        .file-table .fa-file-video { color: #f39c12; }

        /* Smaller buttons for the modal table */
        .btn-modal {
            padding: 5px 10px;
            font-size: 13px;
        }
        .btn-download {
            background-color: #1EAE98;
            border-color: #1EAE98;
        }
        .btn-download:hover {
            background-color: #178D79;
        }
        .btn-delete {
            background-color: #fff;
            color: #e74c3c;
            border-color: #e74c3c;
        }
        .btn-delete:hover {
            background-color: #e74c3c;
            color: #fff;
        }
        /* --- MODAL STYLES END --- */

        .meta-label {
            font-size: 12px;
            font-weight: 600;
            color: #6B7280;
            text-transform: uppercase;
            margin-right: 6px;
        }

        .meta-value {
            font-size: 15px;
            font-weight: 500;
            color: #111827;
        }

        /* ✅ Topics list (flat rows like chapters panel) */
        .topics-list{
          display: flex;
          flex-direction: column;
          gap: 12px;
          margin-top: 16px;
        }

        .topic-row{
          display: grid;
          grid-template-columns: 1fr 140px;
          gap: 14px;
          padding: 12px 14px;
          border-radius: 12px;
          border: 1px solid #e5e7eb;
          background: #ffffff;
          border-left: 4px solid #e5e7eb;
          transition: 0.18s ease;
        }

        .topic-row:hover{
          border-color: #dbeafe;
          border-left-color: #1eae98;
          box-shadow: 0 4px 14px rgba(15, 23, 42, 0.05);
          transform: translateY(-1px);
        }

        .topic-main{
          display: flex;
          flex-direction: column;
          gap: 5px;
        }

        .topic-name{
          font-size: 15px;
          font-weight: 550;
          color: #0f172a;
        }

        .topic-subtext{
          font-size: 13px;
          color: #64748b;
        }

        .topic-action{
          display: flex;
          justify-content: flex-end;
          align-items: center;
        }

        /* empty state row */
        .topic-empty-row{
          padding: 14px 16px;
          border-radius: 12px;
          border: 1px dashed #e5e7eb;
          background: #fafafa;
          color: #6b7280;
          font-size: 14px;
        }

        .topic-guide{
          display: flex;
          align-items: flex-start;
          gap: 10px;
          padding: 12px 14px;
          margin: 12px 0 18px;
          border-radius: 12px;
          background: #f0faf8;
          border: 1px solid #c7f4e8;
          color: #0f766e;
          font-size: 13px;
          font-weight: 600;
        }
        .topic-guide i{
          margin-top: 2px;
        }

    </style>
</head>
<body>

<div class="dashboard-layout">
    {% include "contributor/sidebar.html" %}
    <main class="main-content">
<!--        <header class="main-header"><h1>Submit Content</h1></header>-->

        <section class="card submission-info">
            <h2 class="card-title">Submission Details</h2>
<!--            <p>Course: <strong>{{ course.course_name }}</strong> ({{ course.course_code }})</p>-->
<!--            <p>Chapter: <strong>Chapter {{ chapter.chapter_number }}: {{ chapter.chapter_name }}</strong></p>-->
            <p>
                <span class="meta-label">Course</span>
                <span class="meta-value">{{ course.course_name }} ({{ course.course_code }})</span>
            </p>

            <p>
                <span class="meta-label">Chapter</span>
                <span class="meta-value">Chapter {{ chapter.chapter_number }}: {{ chapter.chapter_name }}</span>
            </p>

        </section>

        <section class="card topics-card">
            <h2 class="card-title">Chapter Topics</h2>

            <div class="topic-guide">
                <i class="fa-solid fa-circle-info"></i>
                Upload PDF, PPT, or Video for the selected topic.
            </div>

            <!-- Replace table with this -->
            <div class="topics-list">
                {% for topic in topics %}
                {% if topic %}
                <div class="topic-row">
                    <div class="topic-main">
                        <div class="topic-name">{{ topic }}</div>
                    </div>

                    <div class="topic-action">
                        <a class="action-button upload-button"
                           href="{% url 'contributor_upload_file' %}?course_id={{ course.id }}&chapter_id={{ chapter.id }}&topic={{ topic|urlencode }}">
                            <i class="fas fa-upload"></i> Upload
                        </a>
                    </div>
                </div>
                {% else %}
                <div class="topic-empty-row">⚠️ Empty topic found</div>
                {% endif %}
                {% empty %}
                <div class="topic-empty-row">No topics found for this chapter.</div>
                {% endfor %}
            </div>
        </section>



        <section class="final-submission-section">
            <hr class="section-divider">
            <p>Once you have uploaded content for all desired topics, confirm your final submission for this
                chapter.</p>
            <form action="{% url 'confirm_submission' %}" method="POST" style="text-align: center;">
                {% csrf_token %}
                <input type="hidden" name="course_id" value="{{ course.id }}">
                <input type="hidden" name="chapter_id" value="{{ chapter.id }}">

                <button type="submit" class="final-submit-button">
                    <i class="fas fa-check-circle"></i> Confirm Final Submission
                </button>
            </form>
        </section>

    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modalOverlay = document.getElementById('file-modal-overlay');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalTitle = document.getElementById('modal-title');
        const fileListBody = document.getElementById('file-list-tbody');
        const viewButtons = document.querySelectorAll('.view-past-button');

        // Function to open the modal
        const openModal = () => {
            modalOverlay.classList.add('show');
        };

        // Function to close the modal
        const closeModal = () => {
            modalOverlay.classList.remove('show');
        };

        // Close modal listeners
        modalCloseBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                closeModal();
            }
        });

        // Add click listener to all "View" buttons
        viewButtons.forEach(button => {
            button.addEventListener('click', async (e) => {
                e.preventDefault();

                // Find the parent <tr> to get topic data
                const topicRow = e.currentTarget.closest('tr');
                const topicId = topicRow.dataset.topicId;
                const topicName = topicRow.dataset.topicName;

                // Update modal title and show loading state
                modalTitle.textContent = `Files for: ${topicName}`;
                fileListBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Loading...</td></tr>';
                openModal();

                // --- THIS IS WHERE YOU FETCH FROM YOUR NEW BACKEND ---
                try {
                    // You need to create this URL endpoint in Django
                    // It should return JSON like: [{"name": "file.pdf", "type": "pdf", "url": "/download/123", "id": 123}]
                    const response = await fetch(`/get-topic-files/${topicId}/`);

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const files = await response.json();

                    if (files.length === 0) {
                        fileListBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No files submitted for this topic.</td></tr>';
                        return;
                    }

                    // Clear loading state
                    fileListBody.innerHTML = '';

                    // Populate the table with file data
                    files.forEach(file => {
                        let iconClass = 'fa-file';
                        if (file.type === 'pdf') iconClass = 'fa-file-pdf';
                        if (file.type === 'docx') iconClass = 'fa-file-word';
                        if (file.type === 'video') iconClass = 'fa-file-video';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><i class="fas ${iconClass} file-icon"></i> ${file.name}</td>
                            <td>${file.type.toUpperCase()}</td>
                            <td style="text-align: center;">
                                <a href="${file.url}" class="action-button btn-modal btn-download" download>
                                    <i class="fas fa-download"></i>
                                </a>
                                <a href="/delete-file/${file.id}/" class="action-button btn-modal btn-delete">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </td>
                        `;
                        fileListBody.appendChild(row);
                    });

                } catch (error) {
                    console.error('Error fetching files:', error);
                    fileListBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: red;">Could not load files.</td></tr>';
                }
            });
        });
    });
</script>
</body>
</html>