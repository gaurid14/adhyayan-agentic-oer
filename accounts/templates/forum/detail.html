{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ question.title }} • OER Forum</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'accounts/sidebar.css' %}">
  <link rel="stylesheet" href="{% static 'accounts/sidebar-drawer.css' %}">
  <link rel="stylesheet" href="{% static 'accounts/forum.css' %}">
</head>

<body>
  <!-- Mobile sidebar toggle -->
  <button
    class="sidebar-toggle"
    type="button"
    id="sidebarToggle"
    aria-label="Open menu"
    aria-controls="sidebar"
    aria-expanded="false"
  >
    ☰ Menu
  </button>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  {% if user.is_authenticated and user.role == "CONTRIBUTOR" %}
    {% include "contributor/sidebar.html" %}
  {% else %}
    {% include "student/sidebar.html" %}
  {% endif %}

  <main class="main">
    <a href="{% url 'forum_home' %}" class="text-decoration-none mb-3 d-inline-block">
      ← All discussions
    </a>

    <!-- QUESTION -->
    <div class="card forum-card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div style="min-width:0;">
            <h4 class="mb-1">{{ question.title }}</h4>
            <div class="meta">
              by <strong>{{ question.author.username }}</strong>
              • {{ question.created_at|date:"M d, Y H:i" }}
              • {{ question.created_at|timesince }} ago
            </div>

            <div class="mt-3">{{ question.content|linebreaks }}</div>

            <div class="mt-3 d-flex gap-2 flex-wrap">
              {% for t in question.topics.all %}
                <span class="chip"><i class="fa-solid fa-tag"></i> {{ t.name }}</span>
              {% endfor %}
            </div>
          </div>

          {% if user.is_authenticated %}
  <form method="post" action="{% url 'forum_question_upvote' question.id %}" class="vote-form">
    {% csrf_token %}
    <button
      class="vote-btn"
      data-upvote-url="{% url 'forum_question_upvote' question.id %}"
      type="submit"
      title="Upvote"
    >
      <span class="vote-icon">▲</span>
      <span class="vote-count" data-upvote-count>{{ question.upvote_count  }}</span>
    </button>
  </form>
{% endif %}

        </div>
      </div>
    </div>

    <!-- ANSWER FORM -->
    {% if user.is_authenticated %}
      <div class="card forum-card mb-4">
        <div class="card-body">
          <h6 class="mb-2">Your Answer</h6>
          <form method="post" action="{% url 'forum_answer' question.id %}">
            {% csrf_token %}
            {{ a_form.content }}
            <button class="btn btn-primary btn-sm mt-2">Submit Answer</button>
          </form>
        </div>
      </div>
    {% else %}
      <div class="alert alert-info">
        Please <a href="{% url 'login' %}">login</a> to answer.
      </div>
    {% endif %}

    <!-- ANSWERS -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0">Answers</h6>
      <div class="meta">{{ question.top_answers|length }} total</div>
    </div>

    {% for grp in question.thread_groups %}
  <!-- Top-level answer = ONE card -->
  <div class="card forum-card mb-3">
    <div class="card-body">
      {% include "forum/partials/answer_row.html" with answer=grp.top question=question level=0 %}
    </div>

    <!-- Replies = NO card/box -->
    {% if grp.replies %}
      <div class="thread-replies px-3 pb-3">
        {% for item in grp.replies %}
          {% include "forum/partials/answer_row.html" with answer=item.answer question=question level=item.level %}
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% empty %}
  <div class="text-muted">No answers yet.</div>
{% endfor %}



  </main>

  <script src="{% static 'accounts/sidebar-drawer.js' %}"></script>
  <script src="{% static 'accounts/forum.js' %}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
</body>
</html>
