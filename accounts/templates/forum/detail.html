{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ question.title }} • OER Forum</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'accounts/sidebar.css' %}">
  <link rel="stylesheet" href="{% static 'accounts/sidebar-drawer.css' %}">
  <link rel="stylesheet" href="{% static 'accounts/forum.css' %}">
</head>

<body class="forum-detail">
  <!-- Mobile sidebar toggle -->
  <button
    class="sidebar-toggle"
    type="button"
    id="sidebarToggle"
    aria-label="Open menu"
    aria-controls="sidebar"
    aria-expanded="false"
  >
    ☰ Menu
  </button>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  {% if user.is_authenticated and user.role == "CONTRIBUTOR" %}
    {% include "contributor/sidebar.html" %}
  {% else %}
    {% include "student/sidebar.html" %}
  {% endif %}



<main class="main">
  <div class="thread-topbar">
    <a href="{% url 'forum_home' %}" class="back-link">
      <span class="back-icon">←</span> All discussions
    </a>

    <div class="thread-actions"></div>
  </div>
  {% if messages %}
    <div class="px-2 px-md-0 mt-2">
      {% for message in messages %}
        {% if 'error' in message.tags %}
          <div class="alert alert-danger">{{ message }}</div>
        {% elif 'success' in message.tags %}
          <div class="alert alert-success">{{ message }}</div>
        {% elif 'warning' in message.tags %}
          <div class="alert alert-warning">{{ message }}</div>
        {% else %}
          <div class="alert alert-info">{{ message }}</div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
    <!-- QUESTION -->
    <div class="card forum-card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div style="min-width:0;">
            <div class="q-head">
  <h4 class="q-title mb-1">{{ question.title }}</h4>
  <div class="meta">
    by <strong>{{ question.author.username }}</strong>
    • {{ question.created_at|date:"M d, Y H:i" }}
    • {{ question.created_at|timesince }} ago

  {% if user.is_authenticated and user.id != question.author_id %}
    <div class="mt-2 d-flex flex-wrap gap-2">
      <details>
        <summary class="btn btn-sm btn-outline-danger">Report post</summary>
        <form class="mt-2" method="post" action="{% url 'forum_report' %}">
          {% csrf_token %}
          <input type="hidden" name="kind" value="question">
          <input type="hidden" name="target_id" value="{{ question.id }}">
          <select name="reason" class="form-select form-select-sm mb-2" required>
            <option value="" selected disabled>Select reason…</option>
            <option value="abuse_harassment">Abusive / Harassing</option>
            <option value="hate_discrimination">Hate / Discrimination</option>
            <option value="violence_threat">Violence / Threat</option>
            <option value="sexual_obscene">Sexual / Obscene</option>
            <option value="spam">Spam</option>
            <option value="privacy">Privacy / Personal info</option>
            <option value="cheating">Cheating / Academic dishonesty</option>
            <option value="other">Other</option>
          </select>
          <textarea name="note" class="form-control form-control-sm mb-2" rows="2" placeholder="Optional note (what happened?)"></textarea>
          <button class="btn btn-sm btn-danger" type="submit">Send report</button>
        </form>
      </details>

      <details>
        <summary class="btn btn-sm btn-outline-secondary">Report user</summary>
        <form class="mt-2" method="post" action="{% url 'forum_report' %}">
          {% csrf_token %}
          <input type="hidden" name="kind" value="user">
          <input type="hidden" name="target_id" value="{{ question.author_id }}">
          <select name="reason" class="form-select form-select-sm mb-2" required>
            <option value="" selected disabled>Select reason…</option>
            <option value="abuse_harassment">Abusive / Harassing</option>
            <option value="hate_discrimination">Hate / Discrimination</option>
            <option value="violence_threat">Violence / Threat</option>
            <option value="sexual_obscene">Sexual / Obscene</option>
            <option value="spam">Spam</option>
            <option value="privacy">Privacy / Personal info</option>
            <option value="cheating">Cheating / Academic dishonesty</option>
            <option value="other">Other</option>
          </select>
          <textarea name="note" class="form-control form-control-sm mb-2" rows="2" placeholder="Optional note"></textarea>
          <button class="btn btn-sm btn-secondary" type="submit">Send report</button>
        </form>
      </details>

      {% if is_blocking_author %}
<form method="post" action="{% url 'forum_unblock_user' question.author_id %}">
  {% csrf_token %}
  <input type="hidden" name="next" value="{{ request.path }}">
  <button type="submit" class="btn btn-outline-secondary btn-sm">
    Unblock
  </button>
</form>
      {% else %}
        <form method="post" action="{% url 'forum_block_user' question.author_id %}">
  {% csrf_token %}
  <input type="hidden" name="next" value="{% url 'forum_home' %}">
  <button type="submit" class="btn btn-outline-danger btn-sm">
    Block
  </button>
</form>
      {% endif %}
    </div>
  {% endif %}

  </div>

  <div class="q-pills mt-2">
    {% if question.course %}<span class="pill"><i class="fa-solid fa-graduation-cap"></i> {{ question.course }}</span>{% endif %}
    {% if question.chapter %}<span class="pill"><i class="fa-regular fa-bookmark"></i> {{ question.chapter }}</span>{% endif %}
  </div>
</div>

<div class="q-body prose mt-3">{{ question.content|linebreaks }}</div>



{% if question.topics.all %}
  <div class="mt-3 d-flex gap-2 flex-wrap">
    {% for t in question.topics.all %}
      <span class="chip"><i class="fa-solid fa-tag"></i> {{ t.name }}</span>
    {% endfor %}
  </div>
{% endif %}
          </div>

          <div class="d-flex align-items-start gap-2">
  {% if user.is_authenticated %}
    <form method="post" action="{% url 'forum_question_upvote' question.id %}" class="vote-form">
      {% csrf_token %}
      <button
        class="vote-btn"
        data-upvote-url="{% url 'forum_question_upvote' question.id %}"
        type="submit"
        title="Upvote"
      >
        <span class="vote-icon">▲</span>
        <span class="vote-count" data-upvote-count>{{ question.upvote_count }}</span>
      </button>
    </form>
  {% endif %}

 {% if user.is_authenticated %}
  {% if user.id == question.author_id or user.is_staff %}
    <div class="d-flex flex-column gap-2">
      <a class="btn btn-sm btn-outline-primary" href="{% url 'forum_question_edit' question.id %}">Edit</a>
      <a class="btn btn-sm btn-outline-danger" href="{% url 'forum_question_delete' question.id %}">Delete</a>
    </div>
  {% endif %}
{% endif %}
</div>

        </div>
      </div>
    </div>
{% include "forum/partials/guidelines_card.html" %}
    <!-- ANSWER FORM -->
    {% if user.is_authenticated %}
      <div class="card forum-card mb-4">
        <div class="card-body">
          <div class="composer-head">
  <h6 class="mb-0">Your answer</h6>
  <div class="meta">Be specific: mention what you tried, errors, and expected output.</div>
</div>

<form method="post" action="{% url 'forum_answer' question.id %}" class="composer-form">
  {% csrf_token %}
  <div class="composer-input">
    {{ a_form.content }}
  </div>
  <div class="composer-actions">
    <button class="btn btn-primary btn-sm" type="submit">
      <i class="fa-regular fa-paper-plane"></i> Submit answer
    </button>
  </div>
</form>
        </div>
      </div>
    {% else %}
      <div class="alert alert-info">
        Please <a href="{% url 'login' %}">login</a> to answer.
      </div>
    {% endif %}

    <!-- ANSWERS -->
    <div class="answers-head">
  <div>
    <h6 class="mb-0">Answers</h6>
    <div class="meta">{{ question.top_answers|length }} total</div>
  </div>
</div>

    {% for grp in question.thread_groups %}
  <!-- Top-level answer = ONE card -->
  <div class="card forum-card mb-3">
    <div class="card-body">
      {% include "forum/partials/answer_row.html" with answer=grp.top question=question level=0 %}
    </div>

    <!-- Replies = NO card/box -->
    {% if grp.replies %}
      <div class="thread-replies px-3 pb-3">
        {% for item in grp.replies %}
          {% include "forum/partials/answer_row.html" with answer=item.answer question=question level=item.level %}
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% empty %}
  <div class="text-muted">No answers yet.</div>
{% endfor %}



  </main>

  <script src="{% static 'accounts/sidebar-drawer.js' %}"></script>
  <script src="{% static 'accounts/forum.js' %}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
</body>
</html>
