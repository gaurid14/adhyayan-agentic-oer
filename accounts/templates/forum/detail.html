{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ question.title }} • OER Forum</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'accounts/sidebar.css' %}">
  <link rel="stylesheet" href="{% static 'accounts/sidebar-drawer.css' %}">
  <link rel="stylesheet" href="{% static 'accounts/forum.css' %}">
</head>

<body class="forum-detail">
  <!-- Mobile sidebar toggle -->
  <button
    class="sidebar-toggle"
    type="button"
    id="sidebarToggle"
    aria-label="Open menu"
    aria-controls="sidebar"
    aria-expanded="false"
  >
    ☰ Menu
  </button>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  {% if user.is_authenticated and user.role == "CONTRIBUTOR" %}
    {% include "contributor/sidebar.html" %}
  {% else %}
    {% include "student/sidebar.html" %}
  {% endif %}



<main class="main">
  <div class="thread-topbar">
    <a href="{% url 'forum_home' %}" class="back-link">
      <span class="back-icon">←</span> All discussions
    </a>

    <div class="thread-actions"></div>
  </div>
  {% if messages %}
    <div class="px-2 px-md-0 mt-2">
      {% for message in messages %}
        {% if 'error' in message.tags %}
          <div class="alert alert-danger">{{ message }}</div>
        {% elif 'success' in message.tags %}
          <div class="alert alert-success">{{ message }}</div>
        {% elif 'warning' in message.tags %}
          <div class="alert alert-warning">{{ message }}</div>
        {% else %}
          <div class="alert alert-info">{{ message }}</div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
    <!-- QUESTION -->
    <div class="card forum-card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div style="min-width:0;">
            <div class="q-head">
  <h4 class="q-title mb-1">{{ question.title }}</h4>
  <div class="meta">
    by <strong>{{ question.author.username }}</strong>
    • {{ question.created_at|date:"M d, Y H:i" }}
    • {{ question.created_at|timesince }} ago
  </div>

  <div class="q-pills mt-2">
    {% if question.course %}<span class="pill"><i class="fa-solid fa-graduation-cap"></i> {{ question.course }}</span>{% endif %}
    {% if question.chapter %}<span class="pill"><i class="fa-regular fa-bookmark"></i> {{ question.chapter }}</span>{% endif %}
  </div>
</div>

<div class="q-body prose mt-3">{{ question.content|linebreaks }}</div>



{% if question.topics.all %}
  <div class="mt-3 d-flex gap-2 flex-wrap">
    {% for t in question.topics.all %}
      <span class="chip"><i class="fa-solid fa-tag"></i> {{ t.name }}</span>
    {% endfor %}
  </div>
{% endif %}
          </div>

          {% if user.is_authenticated %}
  <form method="post" action="{% url 'forum_question_upvote' question.id %}" class="vote-form">
    {% csrf_token %}
    <button
      class="vote-btn"
      data-upvote-url="{% url 'forum_question_upvote' question.id %}"
      type="submit"
      title="Upvote"
    >
      <span class="vote-icon">▲</span>
      <span class="vote-count" data-upvote-count>{{ question.upvote_count  }}</span>
    </button>
  </form>
{% endif %}

        </div>
      </div>
    </div>
{% include "forum/partials/guidelines_card.html" %}
    <!-- ANSWER FORM -->
    {% if user.is_authenticated %}
      <div class="card forum-card mb-4">
        <div class="card-body">
          <div class="composer-head">
  <h6 class="mb-0">Your answer</h6>
  <div class="meta">Be specific: mention what you tried, errors, and expected output.</div>
</div>

<form method="post" action="{% url 'forum_answer' question.id %}" class="composer-form">
  {% csrf_token %}
  <div class="composer-input">
    {{ a_form.content }}
  </div>
  <div class="composer-actions">
    <button class="btn btn-primary btn-sm" type="submit">
      <i class="fa-regular fa-paper-plane"></i> Submit answer
    </button>
  </div>
</form>
        </div>
      </div>
    {% else %}
      <div class="alert alert-info">
        Please <a href="{% url 'login' %}">login</a> to answer.
      </div>
    {% endif %}

    <!-- ANSWERS -->
    <div class="answers-head">
  <div>
    <h6 class="mb-0">Answers</h6>
    <div class="meta">{{ question.top_answers|length }} total</div>
  </div>
</div>

    {% for grp in question.thread_groups %}
  <!-- Top-level answer = ONE card -->
  <div class="card forum-card mb-3">
    <div class="card-body">
      {% include "forum/partials/answer_row.html" with answer=grp.top question=question level=0 %}
    </div>

    <!-- Replies = NO card/box -->
    {% if grp.replies %}
      <div class="thread-replies px-3 pb-3">
        {% for item in grp.replies %}
          {% include "forum/partials/answer_row.html" with answer=item.answer question=question level=item.level %}
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% empty %}
  <div class="text-muted">No answers yet.</div>
{% endfor %}



  </main>

  <script src="{% static 'accounts/sidebar-drawer.js' %}"></script>
  <script src="{% static 'accounts/forum.js' %}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
</body>
</html>
