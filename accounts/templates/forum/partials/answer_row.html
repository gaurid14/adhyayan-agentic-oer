<div id="a{{ answer.id }}"
     class="thread-row {% if level > 0 %}thread-child{% endif %}"
     style="--lvl:{{ level }}">

  <div class="answer-item {% if level > 0 %}answer-item--reply{% endif %} {% if answer.author_id == question.author_id %}answer-item--op{% endif %}">
    <div class="answer-avatar {% if answer.author_id == question.author_id %}answer-avatar--op{% endif %}" aria-hidden="true">
      {{ answer.author.username|slice:":1"|upper }}
    </div>

    <div class="answer-main">
      <div class="answer-meta">
        <span class="answer-author">{{ answer.author.username }}</span>

        {% if answer.author_id == question.author_id %}
          <span class="badge badge-author">Author</span>
        {% endif %}

        <span class="dot">•</span>
        <span>{{ answer.created_at|date:"M d, Y H:i" }}</span>
        <span class="dot">•</span>
        <span>{{ answer.created_at|timesince }} ago</span>

      {% if user.is_authenticated and user.id != answer.author_id %}
        <div class="mt-2 d-flex flex-wrap gap-2">
          <details>
            <summary class="btn btn-sm btn-outline-danger">Report</summary>
            <form class="mt-2" method="post" action="{% url 'forum_report' %}">
              {% csrf_token %}
              <input type="hidden" name="kind" value="answer">
              <input type="hidden" name="target_id" value="{{ answer.id }}">
              <select name="reason" class="form-select form-select-sm mb-2" required>
                <option value="" selected disabled>Select reason…</option>
                <option value="abuse_harassment">Abusive / Harassing</option>
                <option value="hate_discrimination">Hate / Discrimination</option>
                <option value="violence_threat">Violence / Threat</option>
                <option value="sexual_obscene">Sexual / Obscene</option>
                <option value="spam">Spam</option>
                <option value="privacy">Privacy / Personal info</option>
                <option value="cheating">Cheating / Academic dishonesty</option>
                <option value="other">Other</option>
              </select>
              <textarea name="note" class="form-control form-control-sm mb-2" rows="2" placeholder="Optional note"></textarea>
              <button class="btn btn-sm btn-danger" type="submit">Send</button>
            </form>
          </details>

          <form method="post" action="{% url 'forum_block_user' answer.author_id %}">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-secondary" type="submit">Block</button>
          </form>
        </div>
      {% endif %}

      </div>
{% if answer.is_hidden and answer.moderation_status == "pending_review" %}
  {% if user.is_authenticated %}
    {% if user.is_staff or user.id == answer.author_id %}
      <span class="badge text-bg-warning ms-2">
        <i class="fa-solid fa-eye-slash"></i> Pending review
      </span>
    {% endif %}
  {% endif %}
{% endif %}

      <div class="answer-body prose">
        {{ answer.content|linebreaks }}
      </div>

      {% if user.is_authenticated %}
        <div class="answer-actions">

          <details class="reply-box" data-reply-box>
            <summary class="reply-toggle">
              </i> Reply
            </summary>

            <form method="post"
      action="{% url 'forum_reply' question.id answer.id %}"
      class="reply-form mt-2">
  {% csrf_token %}

  <div class="reply-compose">
    <textarea
      name="content"
      class="form-control reply-input"
      rows="2"
      placeholder="Write a reply…"
      data-enter-submit
      data-reply-input
    ></textarea>

    <button class="btn btn-primary reply-send" type="submit">
      Post
    </button>
  </div>

  <div class="reply-hint">
    Enter to send • Shift+Enter for new line
  </div>
</form>

          </details>
        </div>
      {% endif %}
    </div>

    {% if user.is_authenticated %}
      <form method="post" action="{% url 'forum_answer_upvote' answer.id %}" class="vote-form">
        {% csrf_token %}
        <button
          class="vote-btn"
          data-upvote-url="{% url 'forum_answer_upvote' answer.id %}"
          type="submit"
          title="Upvote"
        >
          <span class="vote-icon">▲</span>
          <span class="vote-count" data-upvote-key="a{{ answer.id }}" data-upvote-count>
            {{ answer.upvote_count }}
          </span>
        </button>
      </form>
    {% endif %}
  </div>
</div>
