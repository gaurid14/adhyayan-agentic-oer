{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ course.course_name }} | {{ chapter.chapter_name }}</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body{margin:0;font-family:Inter,sans-serif;background:#f4f7fb;}
        .learning-header{background:linear-gradient(135deg,#0f5f56,#157a6e);color:white;padding:28px 6%;}
        .learning-header h1{margin:0;font-size:26px;font-weight:800;}
        .learning-header p{margin-top:6px;opacity:.9;}
        .container{width:92%;max-width:1400px;margin:25px auto;}
        .layout{display:grid;grid-template-columns:360px 1fr;gap:24px;}
        @media(max-width:1000px){.layout{grid-template-columns:1fr;}}
        .sidebar{background:white;border-radius:18px;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,.06);position:sticky;top:20px;height:fit-content;}
        .sidebar h2{margin:0 0 15px;font-size:17px;}
        select{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-bottom:18px;}
        .topic-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;text-decoration:none;color:#222;font-weight:600;transition:.25s;}
        .topic-item:hover{background:#eef7f6;}
        .topic-active{background:#dff4f1;color:#0f5f56;}
        .content{background:white;border-radius:18px;padding:24px;box-shadow:0 8px 24px rgba(0,0,0,.06);}
        .divider{height:1px;background:#eee;margin:18px 0;}
        .player{border-radius:14px;overflow:hidden;border:1px solid #ddd;margin-top:12px;background:#000;}
        iframe{width:100%;border:none;}
        .empty{background:#f7fafc;padding:30px;border-radius:14px;text-align:center;color:#666;}
        .badge{background:#e6f6f4;color:#0f5f56;padding:5px 10px;border-radius:999px;font-size:12px;font-weight:700;}
        .top-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;}
        .back-btn{text-decoration:none;background:white;color:#0f5f56;padding:8px 14px;border-radius:10px;font-weight:600;border:1px solid rgba(0,0,0,0.08);box-shadow:0 3px 8px rgba(0,0,0,.05);}
        .file-list{margin:0;padding:0;list-style:none;display:grid;gap:10px;}
        .file-card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center;gap:12px;}
        .file-name{font-weight:700;color:#0f172a;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .file-actions{display:flex;gap:8px;flex-wrap:wrap;}
        .btn{display:inline-block;text-decoration:none;padding:6px 10px;border-radius:10px;font-weight:700;font-size:12px;border:1px solid #e5e7eb;color:#0f5f56;background:#fff;}
        .btn:hover{background:#eef7f6;}
        .hint{font-size:12px;color:#64748b;margin-top:6px;}
    </style>
</head>

<body>
    <div class="learning-header">
        <div class="top-nav">
            <a class="back-btn" href="/dashboard/student/">‚Üê Back to Dashboard</a>
            <div class="badge">Student Learning Mode</div>
        </div>

        <h1>{{ course.course_name }} ‚Ä¢ {{ chapter.chapter_name }}</h1>
        <p>{{ course.course_code }} ‚Ä¢ Semester {{ course.semester }}</p>
    </div>

    <div class="container">
        <div class="layout">

            <!-- Sidebar -->
            <div class="sidebar">
                <h2>üìò Syllabus Explorer</h2>

                <form method="get">
                    <select name="chapter_id" onchange="this.form.submit()">
                        {% for ch in chapters %}
                            <option value="{{ ch.id }}" {% if ch.id == chapter.id %}selected{% endif %}>
                                Chapter {{ ch.chapter_number }}: {{ ch.chapter_name }}
                            </option>
                        {% endfor %}
                    </select>
                </form>

                {% if topics %}
                    {% for t in topics %}
                        <a href="?chapter_id={{ chapter.id }}&topic={{ t }}"
                           class="topic-item {% if selected_topic == t %}topic-active{% endif %}">
                            <span>{{ t }}</span> <span>‚Üí</span>
                        </a>
                    {% endfor %}
                {% else %}
                    <p style="color:#666;margin:0;">No description available</p>
                {% endif %}
            </div>

            <!-- Content -->
            <div class="content">
                {% if not is_released %}
                    <div class="empty">
                        <h3 style="margin:0 0 6px;">Content not released yet</h3>
                        <p style="margin:0;">This chapter will appear here once it meets the release rules.</p>
                    </div>
                {% else %}
                    <div style="text-align:left;">
                        <h3 style="margin:0 0 6px;">Study Materials</h3>
                        <p style="margin:0;">Files available for this chapter:</p>
                        <div class="divider"></div>

                        {% if files_for_ui %}
                            <ul class="file-list">
                                {% for f in files_for_ui %}
                                    <li class="file-card">
                                        <div style="min-width:0;">
                                            <div class="file-name" title="{{ f.name }}">{{ f.name }}</div>
                                            <div style="color:#64748b;font-size:12px;">{{ f.mimeType }}</div>
                                            <div class="hint">Opens inside OER (no Google Drive navigation)</div>
                                        </div>
                                        <div class="file-actions">
                                            <a class="btn" href="{{ f.stream_url }}" target="_blank" rel="noopener">Open</a>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p style="margin:0;color:#666;">No files found for this chapter.</p>
                        {% endif %}
                    </div>

                    {% if pdf_id %}
                        <div class="divider"></div>
                        <h3 style="margin:0 0 10px;">PDF Preview</h3>
                        <div class="player">
                            <iframe src="{% url 'drive_stream' course.id pdf_id %}" height="520"></iframe>
                        </div>
                    {% endif %}

                    {% if video_id %}
                        <div class="divider"></div>
                        <h3 style="margin:0 0 10px;">Video Preview</h3>
                        <div class="player" style="padding:12px;background:#000;">
                            <video
                                controls
                                preload="metadata"
                                style="width:100%;border-radius:12px;"
                                src="{% url 'drive_stream' course.id video_id %}">
                            </video>
                        </div>
                    {% endif %}
                {% endif %}
            </div>

        </div>
    </div>
</body>
</html>